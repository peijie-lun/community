<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ç¤¾å€å®¢æœç³»çµ± Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    .navbar-brand { font-weight: 800; letter-spacing:.5px; }
    .tile{
      position:relative;display:block;border:0;border-radius:18px;
      padding:24px;min-height:200px;background-size:cover;background-position:center;
      overflow:hidden;color:#fff;text-shadow:0 1px 2px rgba(0,0,0,.25);
      box-shadow:0 10px 24px rgba(0,0,0,.08);cursor:pointer;
      transition:transform .15s, box-shadow .15s, filter .15s;
    }
    .tile:hover{ transform:translateY(-2px);box-shadow:0 16px 36px rgba(0,0,0,.14);filter:saturate(1.05); }
    .tile-overlay{ position:absolute; inset:0; background:rgba(0,163,153,.88); }
    .tile-items{ line-height:1.9; font-weight:600; opacity:.98; }

    /* --- Chatbot Widget --- */
    .cb-wrap{ position:fixed; right:20px; bottom:20px; z-index:1050; font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial; }
    .cb-btn{ min-width:120px; height:72px; border-radius:36px; display:flex; align-items:center; justify-content:center; gap:8px; background:#013330; color:#fff; border:none; box-shadow:0 10px 25px rgba(0,0,0,.25); cursor:pointer; font-size:18px; font-weight:500; }
    .cb-btn .icon{ font-size:24px; line-height:1; }
    .cb-panel{ width:320px; max-height:60vh; border-radius:14px; box-shadow:0 18px 45px rgba(0,0,0,.25); overflow:hidden; display:none; background:#fff; margin-bottom:10px; }
    .cb-header{ background:#013330; color:#fff; padding:10px 12px; display:flex; align-items:center; justify-content:space-between; }
    .cb-close{ background:transparent; border:0; color:#fff; font-size:22px; line-height:1; }
    .cb-body{ padding:10px; height:280px; overflow:auto; background:#f7f8fa; }
    .cb-msg{ display:flex; margin-bottom:8px; }
    .cb-msg.bot .bubble{ background:#fff; border:1px solid #e5e7eb; color:#111; }
    .cb-msg.me{ justify-content:flex-end; }
    .cb-msg.me .bubble{ background:#013330; color:#fff; }
    .bubble{ padding:8px 10px; border-radius:12px; max-width:80%; font-size:14px; }
    .cb-footer{ display:flex; gap:6px; padding:10px; background:#fff; border-top:1px solid #eee; }
    .cb-footer input{ flex:1; }
    .cb-suggest{ display:flex; flex-wrap:wrap; gap:6px; padding:8px 10px; background:#f7f8fa; border-top:1px solid #eee; }
    .cb-chip{ font-size:12px; border:1px solid #e5e7eb; background:#fff; border-radius:999px; padding:4px 8px; cursor:pointer; }
    @media (max-width:420px){ .cb-panel{ width:calc(100vw - 24px); right:12px; bottom:84px; } }
  </style>
</head>
<body>

<!-- å°è¦½åˆ— -->
<nav class="navbar navbar-expand-lg bg-white border-bottom">
  <div class="container">
    <a class="navbar-brand fw-bold" href="#!" onclick="backHome()">ç¤¾å€å®¢æœç³»çµ±</a>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#topNav">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="topNav">
      <ul class="navbar-nav ms-3">
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">ğŸ  ä½æˆ¶èˆ‡äººå“¡ç®¡ç†é¡</a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#!" onclick="gotoTab('resident')">ä½æˆ¶è³‡æ–™</a></li>
            <li><a class="dropdown-item" href="#!" onclick="gotoTab('staff')">ä¸»å§”ã€æ¸…æ½”äººå“¡è³‡æ–™</a></li>
            <li><a class="dropdown-item" href="#!" onclick="gotoTab('visitor')">è¨ªå®¢ç´€éŒ„</a></li>
          </ul>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">ğŸ’° è²¡å‹™èˆ‡ç®¡ç†é¡</a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#!" onclick="gotoTab('fee')">ç®¡ç†è²»</a></li>
            <li><a class="dropdown-item" href="#!" onclick="gotoTab('expenditure')">è²¡å‹™æ”¯å‡º</a></li>
          </ul>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">ğŸ“¢ å…¬å‘Šèˆ‡æ´»å‹•é¡</a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" id="navAnnLink" href="#!" onclick="gotoTab('announcement')">ç¤¾å€å…¬å‘Š</a></li>
            <li><a class="dropdown-item" href="#!" onclick="gotoTab('vote')">ç¤¾å€æŠ•ç¥¨</a></li>
            <li><a class="dropdown-item" href="#!" onclick="gotoTab('activity')">ç¤¾å€æ´»å‹•æ™‚ç¨‹</a></li>
            <li><a class="dropdown-item" href="#!" onclick="gotoTab('meeting')">æœƒè­°ç´€éŒ„</a></li>
          </ul>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">ğŸ› ï¸ ç¶­ä¿®èˆ‡å®¢æœé¡</a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#!" onclick="gotoTab('repair')">å ±ä¿®ç”³è«‹</a></li>
            <li><a class="dropdown-item" href="#!" onclick="gotoTab('maintenance')">ç¶­ä¿®ã€ä¿é¤Šç´€éŒ„</a></li>
            <li><a class="dropdown-item" href="#!" onclick="gotoTab('qa')">å®¢æœå•ç­”</a></li>
          </ul>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">ğŸ“¦ ä¿¡ä»¶èˆ‡åŒ…è£¹ç®¡ç†é¡</a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#!" onclick="gotoTab('parcel')">ä¿¡ä»¶åŒ…è£¹</a></li>
          </ul>
        </li>
      </ul>

      <div class="ms-auto d-flex align-items-center gap-2">
        <a class="text-decoration-none text-secondary" href="backend.html">ç¤¾å€ä½æˆ¶</a>

        <!-- åªçµ¦ ç®¡å§”æœƒ / ç®¡ç†å“¡ -->
        <button id="sosNavBtn" class="btn btn-sm btn-danger d-none" onclick="openSOS()">âš ï¸ ç·Šæ€¥é€šå ±</button>

        <div id="authCta" class="d-flex gap-2">
          <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#authModal" onclick="switchAuth('login')">ç™»å…¥</button>
          <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#authModal" onclick="switchAuth('register')">è¨»å†Š</button>
        </div>

        <div id="authUser" class="dropdown d-none">
          <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
            <span id="authName">ä½æˆ¶</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><h6 class="dropdown-header" id="authMail">user@example.com</h6></li>
            <li><a class="dropdown-item" href="#!" data-bs-toggle="modal" data-bs-target="#profileModal">ä¿®æ”¹è³‡æ–™</a></li>
            <li><a class="dropdown-item" href="#!" data-bs-toggle="modal" data-bs-target="#resetPwdModal">å¿˜è¨˜å¯†ç¢¼</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item text-danger" href="#!" onclick="logout()">ç™»å‡º</a></li>
          </ul>
        </div>
      </div>

    </div>
  </div>
</nav>

<!-- ===== å…§å®¹å€ ===== -->
<div class="container py-4">
  <!-- é ‚éƒ¨éŒ¯èª¤æ©«å¹…æœƒæ’åœ¨é€™è£¡ï¼š#bannerBox -->
  <div class="text-center mb-5">
    <h2 class="fw-bold display-6 mb-2">åŠŸèƒ½èˆ‡æœå‹™</h2>
  </div>
  <div class="row g-4 mb-4" id="feature-grid"></div>

  <div class="row g-4">
    <main class="col-12">
      <div class="card shadow-sm">
        <div class="card-body">
          <div id="tab-content"><!-- JS æ³¨å…¥ --></div>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- ===== ç™»å…¥/è¨»å†Š Modal ===== -->
<div class="modal fade" id="authModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="authTitle" class="modal-title">ç™»å…¥</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- ç™»å…¥ -->
        <div id="loginForm">
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input id="loginEmail" type="email" class="form-control" placeholder="name@example.com">
          </div>
          <div class="mb-3">
            <label class="form-label">å¯†ç¢¼</label>
            <input id="loginPwd" type="password" class="form-control" placeholder="è‡³å°‘ 6 ç¢¼">
          </div>
          <div class="row g-2">
            <div class="col-6">
              <label class="form-label">è§’è‰²ï¼ˆDemoï¼‰</label>
              <select id="loginRole" class="form-select">
                <option value="resident">ä½æˆ¶</option>
                <option value="committee">ç®¡å§”æœƒ</option>
                <option value="vendor">å» å•†</option>
                <option value="admin">ç®¡ç†å“¡</option>
              </select>
            </div>
            <div class="col-6 d-none" id="loginVendorWrap">
              <label class="form-label">å…¬å¸åç¨±</label>
              <input id="loginVendor" class="form-control" placeholder="ä¾‹ï¼šæ°´é›»å°ç‹å­">
            </div>
          </div>
          <button id="loginBtn" type="button" class="btn btn-primary w-100 mt-3" onclick="handleLogin()">ç™»å…¥</button>
          <div class="mt-2 small text-muted">æ¸¬è©¦å¸³å¯†ï¼štest@example.com / 123456</div>
        </div>
        <!-- è¨»å†Š -->
        <div id="registerForm" class="d-none">
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input id="regEmail" type="email" class="form-control" placeholder="name@example.com">
          </div>
          <div class="mb-3">
            <label class="form-label">é¡¯ç¤ºåç¨±</label>
            <input id="regName" type="text" class="form-control" placeholder="ç‹å°æ˜">
          </div>
          <div class="mb-3">
            <label class="form-label">å¯†ç¢¼</label>
            <input id="regPwd" type="password" class="form-control" placeholder="è‡³å°‘ 6 ç¢¼">
          </div>
          <div class="row g-2">
            <div class="col-6">
              <label class="form-label">è§’è‰²ï¼ˆDemoï¼‰</label>
              <select id="regRole" class="form-select">
                <option value="resident">ä½æˆ¶</option>
                <option value="committee">ç®¡å§”æœƒ</option>
                <option value="vendor">å» å•†</option>
                <option value="admin">ç®¡ç†å“¡</option>
              </select>
            </div>
            <div class="col-6 d-none" id="regVendorWrap">
              <label class="form-label">å…¬å¸åç¨±</label>
              <input id="regVendor" class="form-control" placeholder="ä¾‹ï¼šæ°´é›»å°ç‹å­">
            </div>
          </div>
          <button class="btn btn-success w-100 mt-3" onclick="handleRegister()">å»ºç«‹å¸³è™Ÿ</button>
        </div>
      </div>
      <div class="modal-footer">
        <button id="switchAuthBtn" class="btn btn-link" onclick="toggleAuth()">åˆ‡æ›åˆ°è¨»å†Š</button>
      </div>
    </div>
  </div>
</div>

<!-- æ™ºèƒ½å®¢æœï¼ˆå³ä¸‹è§’ï¼‰ -->
<div class="cb-wrap" id="cbWrap">
  <div class="cb-panel" id="cbPanel" aria-live="polite">
    <div class="cb-header">
      <strong>æ™ºèƒ½å®¢æœ</strong>
      <button class="cb-close" onclick="toggleChat(false)" aria-label="é—œé–‰">Ã—</button>
    </div>
    <div class="cb-body" id="cbBody"></div>
    <div class="cb-suggest" id="cbSuggest">
      <span class="cb-chip" onclick="sendQuick('ä½æˆ¶è³‡æ–™')">ä½æˆ¶è³‡æ–™</span>
      <span class="cb-chip" onclick="sendQuick('ç®¡ç†è²»')">ç®¡ç†è²»</span>
      <span class="cb-chip" onclick="sendQuick('å ±ä¿®')">å ±ä¿®</span>
      <span class="cb-chip" onclick="sendQuick('ç¤¾å€å…¬å‘Š')">ç¤¾å€å…¬å‘Š</span>
      <span class="cb-chip" onclick="sendQuick('ä¿¡ä»¶åŒ…è£¹')">ä¿¡ä»¶åŒ…è£¹</span>
      <span class="cb-chip" onclick="sendQuick('æŠ•ç¥¨')">æŠ•ç¥¨</span>
    </div>
    <div class="cb-footer">
      <input id="cbInput" type="text" class="form-control form-control-sm" placeholder="è¼¸å…¥å•é¡Œï¼Œä¾‹å¦‚ï¼šå¦‚ä½•ç¹³ç®¡ç†è²»ï¼Ÿ"
             onkeydown="if(event.key==='Enter'){sendChat()}">
      <button class="btn btn-sm btn-primary" onclick="sendChat()">é€å‡º</button>
    </div>
  </div>
  <button class="cb-btn" id="cbBtn" onclick="toggleChat(true)" aria-label="é–‹å•Ÿå®¢æœ">
    <span class="icon">ğŸ’¬</span> å®¢æœæ©Ÿå™¨äºº
  </button>
</div>

<!-- ä¿®æ”¹è³‡æ–™ Modalï¼ˆå«æˆ¿è™Ÿç¶å®šï¼‰ -->
<div class="modal fade" id="profileModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">ä¿®æ”¹è³‡æ–™</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Emailï¼ˆä¸å¯ä¿®æ”¹ï¼‰</label>
          <input id="pfEmail" type="email" class="form-control" disabled>
        </div>
        <div class="mb-3">
          <label class="form-label">é¡¯ç¤ºåç¨±</label>
          <input id="pfName" type="text" class="form-control" placeholder="æ‚¨çš„åç¨±">
        </div>
        <div class="mb-3" id="pfRoomWrap">
          <label class="form-label">æˆ¿è™Ÿï¼ˆDemo ç¶å®šï¼‰</label>
          <input id="pfRoom" type="text" class="form-control" placeholder="ä¾‹å¦‚ï¼šA101">
          <div class="form-text">ä¸€èˆ¬ä½æˆ¶æœƒä¾æ­¤æˆ¿è™Ÿåªé¡¯ç¤ºè‡ªå·±çš„ä½æˆ¶è³‡æ–™</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="saveProfile()">å„²å­˜</button>
      </div>
    </div>
  </div>
</div>

<!-- å¿˜è¨˜å¯†ç¢¼ Modal -->
<div class="modal fade" id="resetPwdModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">å¿˜è¨˜å¯†ç¢¼</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2 small text-muted">Demoï¼šæœƒæ¨¡æ“¬å¯„å‡ºé‡è¨­å¯†ç¢¼é€£çµè‡³æ‚¨çš„ Emailã€‚</div>
        <div class="mb-3">
          <label class="form-label">Email</label>
          <input id="fpEmail" type="email" class="form-control" placeholder="name@example.com">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="sendReset()">å¯„é€é‡è¨­ä¿¡</button>
      </div>
    </div>
  </div>
</div>

<!-- éš±è—æª”æ¡ˆæŒ‘é¸å™¨ï¼ˆä¿ç•™æ“´å……ï¼‰ -->
<input id="hiddenFile" type="file" class="d-none" multiple accept="image/*,.pdf">

<script>
/* ===== å‡è³‡æ–™ ===== */
const demoResidents = [
  { id: 1, name: "ç‹å¤§æ˜", room: "A101", phone: "0912-345678", car: "ABC-1234", moveIn: "2021-09-01", family: "ç‹å¤ªå¤ªã€ç‹å°æ˜" },
  { id: 2, name: "æ—å°ç¾", room: "A102", phone: "0922-222222", car: "XYZ-5678", moveIn: "2023-06-15", family: "æ—çˆ¸çˆ¸ã€æ—åª½åª½" },
];
const demoStaff = [
  { id: 1, name: "æä¸»å§”", role: "ä¸»å§”", phone: "0933-111111" },
  { id: 2, name: "é™³æ¸…æ½”", role: "æ¸…æ½”äººå“¡", phone: "0933-222222" },
];
const demoVisitors = [
  { id: 1, name: "é™³è¨ªå®¢", idCard: "A123456789", room: "A101", in: "2025-08-22 10:00", out: "2025-08-22 11:00", note: "é€æ–‡ä»¶" },
];
const demoFees = [
  { id: 1, room: "A101", amount: 1200, due: "2025-09-10", paid: true, invoice: "INV20250801" },
  { id: 2, room: "A102", amount: 1200, due: "2025-09-10", paid: false, invoice: "INV20250802" },
];
const demoAnnouncements = [
  { id: 1, title: "åœæ°´é€šçŸ¥", content: "8/25ä¸Šåˆ9~12é»åœæ°´ã€‚", time: "2025-08-20", author: "æä¸»å§”", attachment: "" },
];
const demoActivities = [
  { id: 1, name: "ä¸­ç§‹çƒ¤è‚‰", time: "2025-09-15 18:00", location: "ä¸­åº­", signup: "ç¾å ´å ±å", organizer: "ç‹å¤§æ˜" },
];
const demoMaintenances = [
  { id: 1, equipment: "é›»æ¢¯", item: "å¹´åº¦ä¿é¤Š", time: "2025-08-10", handler: "ä¿é¤Šå…¬å¸", cost: 8000, note: "æ­£å¸¸" },
];
const demoQA = [
  { id: 1, room: "A101", q: "åƒåœ¾æ€éº¼åˆ†é¡ï¼Ÿ", a: "è«‹ä¾å…¬å‘Šåˆ†é¡", status: "å·²å›è¦†", time: "2025-08-19" },
];
const demoMeetings = [
  { id: 1, topic: "è²¡å‹™å¯©æŸ¥", time: "2025-08-18", location: "æœƒè­°å®¤", participants: "ä¸»å§”ã€ä½æˆ¶ä»£è¡¨", record: "è¨è«–æ”¶æ”¯", resolution: "é€šé" },
];
const demoExpenditures = [
  { id: 1, item: "æ¸…æ½”ç”¨å“", amount: 1500, date: "2025-08-12", purpose: "å¤§æ¨“æ¸…æ½”", proof: "æ”¶æ“š" },
];
const demoParcels = [
  { id: 1, receiver: "ç‹å¤§æ˜", room: "A101", code: "PKG12345", arrival: "2025-08-21 14:00", received: true },
];

/* å ±ä¿®è³‡æ–™ï¼ˆæ“´å……æ¬„ä½ï¼šassigneeVendor/é€²åº¦ï¼‰ */
const demoRepairs = [
  { id: 'R_demo1', room: "A101", item: "æ°´é¾é ­æ¼æ°´", desc: "å»šæˆ¿æ°´é¾é ­æŒçºŒæ»´æ°´", time: "2025-08-21 10:20",
    status: "ASSIGNED", createdBy:"a101@demo", assigneeVendor:"æ°´é›»å°ç‹å­", photos:[], progress:[] },
];

/* === æŠ•ç¥¨åŠŸèƒ½ï¼šé è¨­æŠ•ç¥¨è³‡æ–™ï¼ˆç°¡æ˜“ Demoï¼‰ === */
const demoVotes = [
  {
    id: 'V_demo1',
    title: 'æ˜¯å¦æ±°æ›å¤§é–€æŒ‡ç´‹è¾¨è­˜ä¸»æ©Ÿï¼Ÿ',
    options: ['åŒæ„', 'ä¸åŒæ„', 'ä¿ç•™ï¼Œéœ€æ›´å¤šè³‡è¨Š'],
    deadline: '2025-09-30 23:59',
    status: 'OPEN',           // OPEN / CLOSED
    createdAt: '2025-08-20 09:00',
    createdBy: 'committee@demo',
    responses: []             // {email, name, role, choice, note, time}
  }
];

/* ===== tabs / cards ===== */
const tabs = [
  { key:"resident", label:"ä½æˆ¶è³‡æ–™" },
  { key:"staff", label:"ä¸»å§”ã€æ¸…æ½”äººå“¡è³‡æ–™" },
  { key:"visitor", label:"è¨ªå®¢ç´€éŒ„" },
  { key:"fee", label:"ç®¡ç†è²»" },
  { key:"announcement", label:"ç¤¾å€å…¬å‘Š" },
  { key:"vote", label:"ç¤¾å€æŠ•ç¥¨" },
  { key:"activity", label:"ç¤¾å€æ´»å‹•æ™‚ç¨‹" },
  { key:"repair", label:"å ±ä¿®ç”³è«‹" },
  { key:"maintenance", label:"ç¶­ä¿®ã€ä¿é¤Šç´€éŒ„" },
  { key:"qa", label:"å®¢æœå•ç­”" },
  { key:"meeting", label:"æœƒè­°ç´€éŒ„" },
  { key:"expenditure", label:"è²¡å‹™æ”¯å‡º" },
  { key:"parcel", label:"ä¿¡ä»¶åŒ…è£¹" },
];

const cards = [
  ["resident","ä½æˆ¶è³‡æ–™","åŸºæœ¬è³‡æ–™ ï½œ ä½æˆ¶è¯çµ¡ ï½œ è»Šä½ ï½œ å®¶åº­æˆå“¡","https://images.unsplash.com/photo-1581091215367-59ab6b3d6321?q=80&w=1600&auto=format&fit=crop"],
  ["staff","ä¸»å§”ã€æ¸…æ½”äººå“¡è³‡æ–™","ä¸»å§” ï½œ æ¸…æ½”äººå“¡","https://images.unsplash.com/photo-1551836022-d5d88e9218df?q=80&w=1600&auto=format&fit=crop"],
  ["visitor","è¨ªå®¢ç´€éŒ„","è¨ªå®¢ç™»è¨˜ ï½œ åˆ°é›¢ç´€éŒ„","https://images.unsplash.com/photo-1517245386807-bb43f82c33c4?q=80&w=1600&auto=format&fit=crop"],
  ["fee","ç®¡ç†è²»","é‡‘é¡ ï½œ åˆ°æœŸæ—¥ ï½œ ç™¼ç¥¨","https://images.unsplash.com/photo-1454165804606-c3d57bc86b40?q=80&w=1600&auto=format&fit=crop"],
  ["announcement","ç¤¾å€å…¬å‘Š","åœæ°´åœé›» ï½œ å€å‹™é€šçŸ¥","https://images.unsplash.com/photo-1529336953121-ad5a0d43d0d2?q=80&w=1600&auto=format&fit=crop"],
  ["vote","ç¤¾å€æŠ•ç¥¨","ç¤¾å€ææ¡ˆ ï½œ ç·šä¸ŠæŠ•ç¥¨","https://images.unsplash.com/photo-1517048676732-d65bc937f952?q=80&w=1600&auto=format&fit=crop"],
  ["activity","ç¤¾å€æ´»å‹•æ™‚ç¨‹","æ´»å‹•è³‡è¨Š ï½œ å ±åæ–¹å¼","https://images.unsplash.com/photo-1529333166437-7750a6dd5a70?q=80&w=1600&auto=format&fit=crop"],
  ["repair","å ±ä¿®ç”³è«‹","ç·šä¸Šå ±ä¿® ï½œ é€²åº¦è¿½è¹¤","https://images.unsplash.com/photo-1503387762-592deb58ef4e?q=80&w=1600&auto=format&fit=crop"],
  ["maintenance","ç¶­ä¿®ã€ä¿é¤Šç´€éŒ„","è¨­å‚™ ï½œ é …ç›® ï½œ èŠ±è²»","https://images.unsplash.com/photo-1518779578993-ec3579fee39f?q=80&w=1600&auto=format&fit=crop"],
  ["qa","å®¢æœå•ç­”","æå•å›è¦† ï½œ è™•ç†ç‹€æ…‹","https://images.unsplash.com/photo-1525186402429-b4ff38bedbec?q=80&w=1600&auto=format&fit=crop"],
  ["meeting","æœƒè­°ç´€éŒ„","ä¸»é¡Œ ï½œ æ±ºè­°äº‹é …","https://images.unsplash.com/photo-1522071820081-009f0129c71c?q=80&w=1600&auto=format&fit=crop"],
  ["expenditure","è²¡å‹™æ”¯å‡º","é …ç›® ï½œ é‡‘é¡ ï½œ æ†‘è­‰","https://images.unsplash.com/photo-1521540216272-a50305cd4421?q=80&w=1600&auto=format&fit=crop"],
  ["parcel","ä¿¡ä»¶åŒ…è£¹","æ”¶ç™¼ä»¶ ï½œ å–ä»¶ç¢¼","https://images.unsplash.com/photo-1540573133985-87b6da6d54a9?q=80&w=1600&auto=format&fit=crop"],
];

/* ===== localStorage Key & Helpers ===== */
const AUTH_KEY="demo_auth_user";
const LSK = { repairs:"kms_repairs", announcements:"kms_ann", fees:"kms_fees", votes:"kms_votes" };

/* ===== å®‰å…¨è§£æ & ç°¡æ˜“é€šçŸ¥ ===== */
function safeParse(raw, fallback){
  try{
    if(typeof raw !== 'string') return fallback; // åªè™•ç†å­—ä¸²(JSON)
    return JSON.parse(raw);
  }catch(e){ return fallback; }
}
const save = (k,v)=> localStorage.setItem(k, JSON.stringify(v));
const load = (k, def)=> safeParse(localStorage.getItem(k), def);

/* ç½®é ‚è¨Šæ¯ï¼ˆå¯è‡ªå‹•éš±è—ï¼‰ */
function toast(msg, type='success', ms=2400){
  let box = document.getElementById('toastBox');
  if(!box){
    box = document.createElement('div');
    box.id = 'toastBox';
    box.style.position='fixed';
    box.style.top='14px';
    box.style.left='50%';
    box.style.transform='translateX(-50%)';
    box.style.zIndex='2000';
    document.body.appendChild(box);
  }
  const el = document.createElement('div');
  el.className = `alert alert-${type} shadow-sm py-2 px-3`;
  el.textContent = msg;
  box.appendChild(el);
  setTimeout(()=>{ el.remove(); if(!box.children.length) box.remove(); }, ms);
}

/* é å…§è­¦ç¤ºæ©«å¹…ï¼ˆå¯æ¸…é™¤ï¼‰ */
function banner(msg='', type='danger'){
  let b = document.getElementById('bannerBox');
  if(!b){
    b = document.createElement('div');
    b.id='bannerBox';
    const container = document.querySelector('.container');
    container?.insertBefore(b, container.firstChild);
  }
  b.innerHTML = msg ? `<div class="alert alert-${type}">è¼‰å…¥å¡ç‰‡æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š${msg}</div>` : '';
}

/* ===== èªè­‰ ===== */
const getUser =()=>JSON.parse(localStorage.getItem(AUTH_KEY)||"null");
const setUser =u=>localStorage.setItem(AUTH_KEY,JSON.stringify(u));
const clearUser=()=>localStorage.removeItem(AUTH_KEY);
const isLoggedIn=()=>!!localStorage.getItem(AUTH_KEY);
const getRole =()=> (getUser()?.role)||"guest";
const gid=(p)=> p+Math.random().toString(36).slice(2,8);
let activeTab=null;

/* åˆå§‹è³‡æ–™å¯«å…¥ localStorage */
if(!localStorage.getItem(LSK.repairs)) save(LSK.repairs, demoRepairs);
if(!localStorage.getItem(LSK.announcements)) save(LSK.announcements, demoAnnouncements);
if(!localStorage.getItem(LSK.fees)) save(LSK.fees, demoFees);
if(!localStorage.getItem(LSK.votes)) save(LSK.votes, demoVotes);

/* ===== å…¬å‘Šæœªè®€ç‹€æ…‹ ===== */
function annReadKey(){
  const email = getUser()?.email;
  return email ? `ann_read_${email}` : null;
}
function getAnnReadSet(){
  const k = annReadKey(); if(!k) return new Set();
  const arr = safeParse(localStorage.getItem(k), []);
  return new Set(arr.map(String));
}
function saveAnnReadSet(set){
  const k = annReadKey(); if(!k) return;
  localStorage.setItem(k, JSON.stringify([...set]));
}
function getUnreadCount(){
  if(!isLoggedIn()) return 0;
  const anns = load(LSK.announcements, []);
  const read = getAnnReadSet();
  return anns.filter(a => !read.has(String(a.id))).length;
}
function markAnnRead(id){
  const set = getAnnReadSet(); set.add(String(id)); saveAnnReadSet(set);
  updateUnreadUI();
  if(activeTab==='announcement') renderTabContent();
}
function markAllAnnRead(){
  const anns = load(LSK.announcements, []);
  saveAnnReadSet(new Set(anns.map(a=>String(a.id))));
  updateUnreadUI();
  if(activeTab==='announcement') renderTabContent();
}
function updateUnreadUI(){
  const nav = document.getElementById('navAnnLink');
  const c = getUnreadCount();
  if(nav){
    nav.innerHTML = `ç¤¾å€å…¬å‘Š ${c>0? `<span class="badge bg-danger ms-2" title="æœªè®€">${c}</span>`:''}`;
  }
  const isHome = !document.getElementById('feature-grid').classList.contains('d-none');
  if(isHome) renderCards();
}

/* ===== æŠ•ç¥¨æœªæŠ•æ•¸ ===== */
function getUnvotedCount(){
  if(!isLoggedIn()) return 0;
  const user = getUser() || {};
  const list = load(LSK.votes, []);
  return list.filter(v => v.status==='OPEN' && !(v.responses||[]).some(r=>r.email===user.email)).length;
}

/* ===== é¦–é å¡ç‰‡ ===== */
function renderCards(){
  const grid=document.getElementById('feature-grid');
  try{
    const unread  = getUnreadCount();
    const unvoted = (typeof getUnvotedCount === 'function') ? getUnvotedCount() : 0;

    const list = Array.isArray(cards) ? cards : [];
    grid.innerHTML = list.map(([key,title,items,bg])=>{
      let badges = '';
      if(key==='announcement' && unread>0){
        badges += `<span class="badge bg-danger position-absolute top-0 end-0 m-2">æœªè®€ ${unread}</span>`;
      }
      if(key==='vote' && unvoted>0){
        badges += `<span class="badge bg-warning text-dark position-absolute top-0 end-0 m-2">æœªæŠ• ${unvoted}</span>`;
      }
      return `
        <div class="col-12 col-md-6 col-lg-4">
          <button class="tile w-100 text-start position-relative" style="background-image:url('${bg}')" onclick="gotoTab('${key}')">
            <div class="tile-overlay"></div>
            ${badges}
            <div class="position-relative">
              <div class="h5 fw-bold mb-2 text-white">${title}</div>
              <div class="tile-items">${items}</div>
            </div>
          </button>
        </div>`;
    }).join('');
    banner('',''); // æ¸…é™¤éŒ¯èª¤æ©«å¹…
  }catch(err){
    console.error('[renderCards] fail:', err);
    grid.innerHTML = '';
    banner(err.message || String(err), 'danger');
  }
}
function backHome(){
  document.getElementById('feature-grid').classList.remove('d-none');
  document.getElementById('tab-content').innerHTML="";
  activeTab=null; renderCards(); updateUnreadUI();
  banner('',''); // æ¸…æ‰éŒ¯èª¤æ©«å¹…
}

/* ===== æœªç™»å…¥å°é æ””æˆª ===== */
let pendingTab = null;
function ensureAuth(redirectTab=null){
  if(isLoggedIn()) return true;
  pendingTab = redirectTab;
  switchAuth('login');
  new bootstrap.Modal(document.getElementById('authModal')).show();
  return false;
}
function gotoTab(key){
  if(!ensureAuth(key)) return;
  activeTab=key;
  document.getElementById('feature-grid').classList.add('d-none');
  renderTabContent();
}

/* ===== è§’è‰²èˆ‡ SOS é¡¯ç¤º ===== */
function updateAuthUI(){
  const cta=document.getElementById('authCta');
  const user=document.getElementById('authUser');
  if(isLoggedIn()){
    const u=getUser()||{};
    cta?.classList.add('d-none'); user?.classList.remove('d-none');
    document.getElementById('authName').textContent=u.name||u.email||'ä½¿ç”¨è€…';
    document.getElementById('authMail').textContent=u.email||'user@example.com';
  }else{
    cta?.classList.remove('d-none'); user?.classList.add('d-none');
  }
  const showSOS = (getRole()==='committee' || getRole()==='admin');
  document.getElementById('sosNavBtn')?.classList.toggle('d-none', !showSOS);
  updateUnreadUI();
}

/* ===== é€šç”¨æœå°‹åŒ…è£ ===== */
function withSearch(tableBlockHtml, placeholder='é—œéµå­—æœå°‹'){
  const id = 'tbl_' + Math.random().toString(36).slice(2,8);
  return `
    <div class="mb-2">
      <input class="form-control form-control-sm" placeholder="${placeholder}"
        oninput="(function(q){
          const wrap = document.getElementById('${id}');
          if(!wrap) return;
          const trs = wrap.querySelectorAll('tbody tr');
          const key = q.value.trim().toLowerCase();
          trs.forEach(tr => { tr.style.display = key==='' || tr.textContent.toLowerCase().includes(key) ? '' : 'none'; });
        })(this)">
    </div>
    <div id="${id}">${tableBlockHtml}</div>`;
}

/* ===== åˆ†é å…§å®¹ ===== */
function renderTabContent(){
  const PLACE = {
    resident:'æœå°‹ï¼šå§“å / æˆ¿è™Ÿ / é›»è©±', staff:'æœå°‹ï¼šå§“å / è·ä½', visitor:'æœå°‹ï¼šå§“å / æˆ¿è™Ÿ / æ™‚é–“',
    fee:'æœå°‹ï¼šæˆ¿è™Ÿ / ç™¼ç¥¨', announcement:'æœå°‹ï¼šæ¨™é¡Œ / å…§å®¹ / ç™¼å¸ƒäºº',
    vote:'æœå°‹ï¼šä¸»é¡Œ / ç‹€æ…‹ / æˆªæ­¢æ—¥',
    activity:'æœå°‹ï¼šæ´»å‹• / åœ°é»',
    repair:'æœå°‹ï¼šæˆ¿è™Ÿ / é …ç›® / ç‹€æ…‹', maintenance:'æœå°‹ï¼šè¨­å‚™ / é …ç›® / è² è²¬äºº', qa:'æœå°‹ï¼šå•é¡Œ / å›è¦† / æˆ¿è™Ÿ',
    meeting:'æœå°‹ï¼šä¸»é¡Œ / åœ°é» / åƒèˆ‡äºº', expenditure:'æœå°‹ï¼šé …ç›® / ç”¨é€” / é‡‘é¡', parcel:'æœå°‹ï¼šæ”¶ä»¶äºº / åŒ…è£¹ç·¨è™Ÿ'
  };
  let html="";

  // ä½æˆ¶è³‡æ–™ï¼ˆæ¬Šé™ï¼‰
  if(activeTab==="resident"){
    const role = getRole();
    if(role==='vendor'){
      html = `<div class="alert alert-warning">æ‚¨ç›®å‰ç‚ºã€Œå» å•†ã€è§’è‰²ï¼Œç„¡æ¬Šé™ç€è¦½ä½æˆ¶è³‡æ–™ã€‚</div>`;
    }else{
      let rows = demoResidents;
      if(role==='resident'){
        const myRoom = getUser()?.room;
        if(!myRoom){
          html = `<div class="alert alert-info">å°šæœªç¶å®šæˆ¿è™Ÿï¼Œè«‹åˆ°ã€Œä¿®æ”¹è³‡æ–™ã€å¡«å¯«æˆ¿è™Ÿå¾Œå†æŸ¥çœ‹ã€‚</div>`;
          document.getElementById('tab-content').innerHTML = html; return;
        }
        rows = demoResidents.filter(r=>r.room===myRoom);
      }
      const tableHtml = `
        <div class="table-responsive"><table class="table table-bordered table-sm mt-3">
          <thead class="table-primary"><tr>
            <th>å§“å</th><th>æˆ¿è™Ÿ</th><th>è¯çµ¡æ–¹å¼</th><th>è»Šä½</th><th>å…¥ä½æ™‚é–“</th><th>å®¶åº­æˆå“¡</th>
          </tr></thead><tbody>
            ${rows.map(r=>`<tr><td>${r.name}</td><td>${r.room}</td><td>${r.phone}</td><td>${r.car}</td><td>${r.moveIn}</td><td>${r.family}</td></tr>`).join('')}
          </tbody></table></div>`;
      html = `<h4>ä½æˆ¶è³‡æ–™</h4>` + withSearch(tableHtml, PLACE[activeTab]);
    }
  }

  if(activeTab==="staff"){
    const tableHtml = `
      <div class="table-responsive"><table class="table table-bordered table-sm mt-3">
        <thead class="table-info"><tr><th>å§“å</th><th>è·ä½</th><th>è¯çµ¡æ–¹å¼</th></tr></thead><tbody>
          ${demoStaff.map(s=>`<tr><td>${s.name}</td><td>${s.role}</td><td>${s.phone}</td></tr>`).join('')}
        </tbody></table></div>`;
    html = `<h4>ä¸»å§”ã€æ¸…æ½”äººå“¡è³‡æ–™</h4>` + withSearch(tableHtml, PLACE[activeTab]);
  }

  if(activeTab==="visitor"){
    const tableHtml = `
      <div class="table-responsive"><table class="table table-bordered table-sm mt-3">
        <thead class="table-secondary"><tr>
          <th>å§“å</th><th>èº«åˆ†è­‰</th><th>æ‹œè¨ªæˆ¿è™Ÿ</th><th>é€²å…¥æ™‚é–“</th><th>é›¢é–‹æ™‚é–“</th><th>å‚™è¨»</th>
        </tr></thead><tbody>
          ${demoVisitors.map(v=>`<tr><td>${v.name}</td><td>${v.idCard}</td><td>${v.room}</td><td>${v.in}</td><td>${v.out}</td><td>${v.note}</td></tr>`).join('')}
        </tbody></table></div>`;
    html = `<h4>è¨ªå®¢ç´€éŒ„</h4>` + withSearch(tableHtml, PLACE[activeTab]);
  }

  if(activeTab==="fee"){
    const fees = load(LSK.fees, demoFees);
    const tableHtml = `
      <div class="table-responsive"><table class="table table-bordered table-sm mt-3">
        <thead class="table-warning"><tr><th>æˆ¿è™Ÿ</th><th>é‡‘é¡</th><th>åˆ°æœŸæ—¥</th><th>å·²ç¹³</th><th>ç™¼ç¥¨è™Ÿç¢¼</th></tr></thead><tbody>
          ${fees.map(f=>`<tr><td>${f.room}</td><td>${f.amount}</td><td>${f.due}</td><td>${f.paid?'æ˜¯':'å¦'}</td><td>${f.invoice}</td></tr>`).join('')}
        </tbody></table></div>`;
    html = `<h4>ç®¡ç†è²»</h4>` + withSearch(tableHtml, PLACE[activeTab]);
  }

  if(activeTab==="announcement"){
    const anns = load(LSK.announcements, []);
    const readSet = getAnnReadSet();
    const tableHtml = `
      <div class="d-flex justify-content-between align-items-center">
        <div class="small text-muted">æœªè®€ï¼š${getUnreadCount()}</div>
        <div><button class="btn btn-sm btn-outline-secondary" onclick="markAllAnnRead()">å…¨éƒ¨æ¨™è¨˜å·²è®€</button></div>
      </div>
      <div class="table-responsive"><table class="table table-bordered table-sm mt-3 align-middle">
        <thead class="table-success"><tr><th style="width:80px">ç‹€æ…‹</th><th>æ¨™é¡Œ</th><th>å…§å®¹</th><th>ç™¼å¸ƒæ™‚é–“</th><th>ç™¼å¸ƒäºº</th><th style="width:100px">é™„ä»¶</th></tr></thead>
        <tbody>
          ${anns.map(a=>{
            const unread = !readSet.has(String(a.id));
            const status = unread ? `<span class="badge bg-danger">æœªè®€</span>` : `<span class="badge bg-secondary">å·²è®€</span>`;
            return `<tr onclick="markAnnRead('${a.id}')">
              <td>${status}</td><td>${a.title}</td><td>${a.content}</td><td>${a.time}</td><td>${a.author}</td><td>${a.attachment||''}</td>
            </tr>`;
          }).join('')}
        </tbody></table></div>`;
    html = `<h4>ç¤¾å€å…¬å‘Š</h4><div class="text-muted small">ï¼ˆé»æ“Šä»»ä¸€åˆ—å¯æ¨™è¨˜ç‚ºå·²è®€ï¼‰</div>` + withSearch(tableHtml, 'æœå°‹ï¼šæ¨™é¡Œ / å…§å®¹ / ç™¼å¸ƒäºº');
  }

  if(activeTab==="vote"){
    const role = getRole();
    const list = load(LSK.votes, []);
    const me = getUser()||{};
    const canManage = (role==='committee' || role==='admin');
    const canVote = (role==='resident' || role==='committee'); // vendor ä¸å¾—æŠ•ï¼›admin é è¨­ä¸æŠ•
    const topBtn = canManage ? `<button class="btn btn-sm btn-primary" onclick="createVote()">ï¼‹ æ–°å¢æŠ•ç¥¨</button>` : '';

    const tableHtml = `
      <div class="d-flex justify-content-between align-items-center">
        <div class="small text-muted">æœªæŠ•ï¼š${getUnvotedCount()}</div>
        <div>${topBtn}</div>
      </div>
      <div class="table-responsive"><table class="table table-bordered table-sm mt-3 align-middle">
        <thead class="table-info"><tr>
          <th>ä¸»é¡Œ</th><th style="width:140px">æˆªæ­¢</th><th style="width:90px">ç‹€æ…‹</th><th>çµ±è¨ˆ</th><th style="width:220px">å‹•ä½œ</th>
        </tr></thead><tbody>
          ${list.map(v=>{
            const counts = Array(v.options.length).fill(0);
            (v.responses||[]).forEach(r=>{ if(Number.isInteger(r.choice)) counts[r.choice]++; });
            const total = counts.reduce((a,b)=>a+b,0);
            const stats = v.options.map((opt, i)=>{
              const c = counts[i]; const pct = total? Math.round(c*100/total):0;
              return `<div class="d-flex justify-content-between"><span>${opt}</span><span>${c}ï¼ˆ${pct}%ï¼‰</span></div>`;
            }).join('');
            const hasVoted = (v.responses||[]).some(r=>r.email===me.email);
            const badge = v.status==='OPEN'
              ? (hasVoted ? `<span class="badge bg-success">å·²æŠ•</span>` : `<span class="badge bg-warning text-dark">æœªæŠ•</span>`)
              : `<span class="badge bg-secondary">å·²é—œé–‰</span>`;

            const voteBtn = (canVote && v.status==='OPEN' && !hasVoted)
              ? `<button class="btn btn-sm btn-primary" onclick="votePoll('${v.id}')">å‰å¾€æŠ•ç¥¨</button>` : '';

            const resultBtn = `<button class="btn btn-sm btn-outline-secondary" onclick="viewVote('${v.id}')">æŸ¥çœ‹çµæœ</button>`;

            const manageBtn = (canManage && v.status==='OPEN')
              ? `<button class="btn btn-sm btn-danger" onclick="closeVote('${v.id}')">é—œé–‰æŠ•ç¥¨</button>` : '';

            return `<tr>
              <td>${v.title}</td>
              <td>${v.deadline||'-'}</td>
              <td>${badge}</td>
              <td>${stats}</td>
              <td class="d-flex gap-2">${voteBtn}${resultBtn}${manageBtn}</td>
            </tr>`;
          }).join('')}
        </tbody></table></div>`;
    html = `<h4>ç¤¾å€æŠ•ç¥¨</h4>` + withSearch(tableHtml, PLACE[activeTab]);
  }

  if(activeTab==="activity"){
    const tableHtml = `
      <div class="table-responsive"><table class="table table-bordered table-sm mt-3">
        <thead class="table-success"><tr><th>æ´»å‹•åç¨±</th><th>æ™‚é–“</th><th>åœ°é»</th><th>å ±åæ–¹å¼</th><th>è² è²¬äºº</th></tr></thead><tbody>
          ${demoActivities.map(a=>`<tr><td>${a.name}</td><td>${a.time}</td><td>${a.location}</td><td>${a.signup}</td><td>${a.organizer}</td></tr>`).join('')}
        </tbody></table></div>`;
    html = `<h4>ç¤¾å€æ´»å‹•æ™‚ç¨‹</h4>` + withSearch(tableHtml, PLACE[activeTab]);
  }

  if(activeTab==="repair"){
    const role = getRole();
    let list = load(LSK.repairs, []);
    if(role==='vendor'){
      const me = (getUser()?.vendorName || getUser()?.name || getUser()?.email || '').toLowerCase();
      list = list.filter(r => (r.assigneeVendor||'').toLowerCase() === me);
    }
    const topBtn = (role==='resident')
      ? `<button class="btn btn-sm btn-primary" onclick="createRepair()">ï¼‹ æ–°å¢å ±ä¿®</button>` : '';

    const tableHtml = `
      <div class="d-flex justify-content-between align-items-center">
        <div class="small text-muted">è§’è‰²ï¼š${role}</div><div>${topBtn}</div>
      </div>
      <div class="table-responsive"><table class="table table-bordered table-sm mt-3">
        <thead class="table-danger"><tr>
          <th>æˆ¿è™Ÿ</th><th>é …ç›®</th><th>æè¿°</th><th>ç”³è«‹æ™‚é–“</th><th>ç‹€æ…‹</th><th>æŒ‡æ´¾å» å•†</th><th>å‹•ä½œ</th>
        </tr></thead><tbody>
          ${list.map(r=>{
            const act = [];
            if((role==='committee' || role==='admin') && r.status==='NEW'){
              act.push(`<button class="btn btn-sm btn-warning" onclick="assignRepair('${r.id}')">æŒ‡æ´¾</button>`);
            }
            if(role==='vendor' && (r.status==='ASSIGNED' || r.status==='IN_PROGRESS')){
              act.push(`<button class="btn btn-sm btn-info" onclick="reportProgress('${r.id}')">å›å ±é€²åº¦</button>`);
            }
            if((role==='committee' || role==='admin') && r.status==='IN_PROGRESS'){
              act.push(`<button class="btn btn-sm btn-success" onclick="closeRepair('${r.id}')">å®Œå·¥</button>`);
            }
            return `<tr>
              <td>${r.room}</td><td>${r.item}</td><td>${r.desc}</td><td>${r.time}</td>
              <td>${r.status}</td><td>${r.assigneeVendor||''}</td><td>${act.join(' ')||'-'}</td>
            </tr>`;
          }).join('')}
        </tbody></table></div>`;
    html = `<h4>å ±ä¿®ç”³è«‹</h4>` + withSearch(tableHtml, PLACE[activeTab]);
  }

  if(activeTab==="maintenance"){
    const tableHtml = `
      <div class="table-responsive"><table class="table table-bordered table-sm mt-3">
        <thead class="table-info"><tr><th>è¨­å‚™åç¨±</th><th>ä¿é¤Šé …ç›®</th><th>æ™‚é–“</th><th>è² è²¬äºº</th><th>èŠ±è²»</th><th>ç´€éŒ„</th></tr></thead><tbody>
          ${demoMaintenances.map(m=>`<tr><td>${m.equipment}</td><td>${m.item}</td><td>${m.time}</td><td>${m.handler}</td><td>${m.cost}</td><td>${m.note}</td></tr>`).join('')}
        </tbody></table></div>`;
    html = `<h4>ç¶­ä¿®ã€ä¿é¤Šç´€éŒ„</h4>` + withSearch(tableHtml, PLACE[activeTab]);
  }

  if(activeTab==="qa"){
    const tableHtml = `
      <div class="table-responsive"><table class="table table-bordered table-sm mt-3">
        <thead class="table-info"><tr><th>æˆ¿è™Ÿ</th><th>å•é¡Œ</th><th>å›è¦†</th><th>ç‹€æ…‹</th><th>æ™‚é–“</th></tr></thead><tbody>
          ${demoQA.map(q=>`<tr><td>${q.room}</td><td>${q.q}</td><td>${q.a}</td><td>${q.status}</td><td>${q.time}</td></tr>`).join('')}
        </tbody></table></div>`;
    html = `<h4>å®¢æœå•ç­”</h4>` + withSearch(tableHtml, PLACE[activeTab]);
  }

  if(activeTab==="meeting"){
    const tableHtml = `
      <div class="table-responsive"><table class="table table-bordered table-sm mt-3">
        <thead class="table-info"><tr><th>ä¸»é¡Œ</th><th>æ™‚é–“</th><th>åœ°é»</th><th>åƒèˆ‡äººå“¡</th><th>ç´€éŒ„</th><th>æ±ºè­°äº‹é …</th></tr></thead><tbody>
          ${demoMeetings.map(m=>`<tr><td>${m.topic}</td><td>${m.time}</td><td>${m.location}</td><td>${m.participants}</td><td>${m.record}</td><td>${m.resolution}</td></tr>`).join('')}
        </tbody></table></div>`;
    html = `<h4>æœƒè­°ç´€éŒ„</h4>` + withSearch(tableHtml, PLACE[activeTab]);
  }

  if(activeTab==="expenditure"){
    const tableHtml = `
      <div class="table-responsive"><table class="table table-bordered table-sm mt-3">
        <thead class="table-warning"><tr><th>æ”¯å‡ºé …ç›®</th><th>é‡‘é¡</th><th>æ—¥æœŸ</th><th>ç”¨é€”</th><th>æ†‘è­‰</th></tr></thead><tbody>
          ${demoExpenditures.map(e=>`<tr><td>${e.item}</td><td>${e.amount}</td><td>${e.date}</td><td>${e.purpose}</td><td>${e.proof}</td></tr>`).join('')}
        </tbody></table></div>`;
    html = `<h4>è²¡å‹™æ”¯å‡º</h4>` + withSearch(tableHtml, PLACE[activeTab]);
  }

  if(activeTab==="parcel"){
    const tableHtml = `
      <div class="table-responsive"><table class="table table-bordered table-sm mt-3">
        <thead class="table-secondary"><tr><th>æ”¶ä»¶äºº</th><th>æˆ¿è™Ÿ</th><th>åŒ…è£¹ç·¨è™Ÿ</th><th>åˆ°é”æ™‚é–“</th><th>é ˜å–ç‹€æ…‹</th></tr></thead><tbody>
          ${demoParcels.map(p=>`<tr><td>${p.receiver}</td><td>${p.room}</td><td>${p.code}</td><td>${p.arrival}</td><td>${p.received?'å·²é ˜å–':'æœªé ˜å–'}</td></tr>`).join('')}
        </tbody></table></div>`;
    html = `<h4>ä¿¡ä»¶åŒ…è£¹</h4>` + withSearch(tableHtml, PLACE[activeTab]);
  }

  document.getElementById('tab-content').innerHTML = html;
}

/* ===== å ±ä¿®æµç¨‹ ===== */
function createRepair(){
  if(getRole()!=='resident'){ toast('åƒ…ä½æˆ¶å¯æ–°å¢å ±ä¿®','danger'); return; }
  const room = getUser()?.room || prompt('æˆ¿è™Ÿï¼Ÿï¼ˆä¾‹å¦‚ A101ï¼‰'); if(!room) return;
  const item = prompt('å ±ä¿®é …ç›®ï¼Ÿï¼ˆä¾‹å¦‚ æ°´é¾é ­æ¼æ°´ï¼‰'); if(!item) return;
  const desc = prompt('æè¿°ï¼Ÿ')||'';
  const list = load(LSK.repairs, []);
  list.unshift({ id: gid('R_'), room, item, desc,
    time: new Date().toISOString().slice(0,16).replace('T',' '),
    status:'NEW', createdBy:getUser()?.email||'', assigneeVendor:'', photos:[], progress:[] });
  save(LSK.repairs, list);
  toast('å ±ä¿®å·²é€å‡ºï¼ˆDemoï¼‰');
  renderTabContent();
}
function assignRepair(id){
  const vendor = prompt('æŒ‡æ´¾å» å•†åç¨±ï¼Ÿï¼ˆéœ€èˆ‡å°æ–¹å…¬å¸åç¨±ä¸€è‡´ï¼‰'); if(!vendor) return;
  const list = load(LSK.repairs, []); const r = list.find(x=>x.id===id); if(!r) return;
  r.assigneeVendor = vendor; r.status = 'ASSIGNED';
  save(LSK.repairs, list); toast('å·²æŒ‡æ´¾ï¼ˆDemoï¼‰'); renderTabContent();
}
function reportProgress(id){
  const note = prompt('é€²åº¦èªªæ˜ï¼Ÿ'); if(note==null) return;
  const list = load(LSK.repairs, []); const r = list.find(x=>x.id===id); if(!r) return;
  r.progress.push({time:new Date().toLocaleString(), note}); r.status = 'IN_PROGRESS';
  save(LSK.repairs, list); toast('å·²å›å ±ï¼ˆDemoï¼‰'); renderTabContent();
}
function closeRepair(id){
  const list = load(LSK.repairs, []); const r = list.find(x=>x.id===id); if(!r) return;
  if(confirm('ç¢ºå®šæ¨™è¨˜ç‚ºå®Œå·¥ï¼Ÿ')){
    r.status = 'DONE'; save(LSK.repairs, list); toast('å·²å®Œå·¥ï¼ˆDemoï¼‰'); renderTabContent();
  }
}

/* ===== æŠ•ç¥¨ï¼šå»ºç«‹ / æŠ•ç¥¨ / æŸ¥çœ‹ / é—œé–‰ ===== */
function createVote(){
  const role = getRole();
  if(!(role==='committee' || role==='admin')){ toast('åƒ…ç®¡å§”æœƒèˆ‡ç®¡ç†å“¡å¯å»ºç«‹æŠ•ç¥¨','danger'); return; }
  const title = prompt('æŠ•ç¥¨ä¸»é¡Œï¼Ÿ'); if(!title) return;
  const optsStr = prompt('é¸é …ï¼ˆä»¥é€—è™Ÿåˆ†éš”ï¼Œè‡³å°‘ 2 é …ï¼‰ï¼š', 'åŒæ„,ä¸åŒæ„'); if(!optsStr) return;
  const options = optsStr.split(',').map(s=>s.trim()).filter(Boolean);
  if(options.length<2){ toast('è‡³å°‘éœ€è¦ 2 å€‹é¸é …','danger'); return; }
  const deadline = prompt('æˆªæ­¢æ™‚é–“ï¼ˆå¯ç•™ç©ºï¼‰ï¼Œä¾‹ï¼š2025-09-30 23:59')||'';
  const list = load(LSK.votes, []);
  list.unshift({
    id: gid('V_'),
    title, options, deadline,
    status:'OPEN', createdAt:new Date().toISOString().slice(0,16).replace('T',' '),
    createdBy: getUser()?.email||'', responses:[]
  });
  save(LSK.votes, list);
  toast('å·²å»ºç«‹æŠ•ç¥¨ï¼ˆDemoï¼‰'); renderTabContent(); renderCards();
}
function votePoll(id){
  const role = getRole();
  if(!(role==='resident' || role==='committee')){ toast('æ‚¨çš„è§’è‰²ç„¡æ³•æŠ•ç¥¨','danger'); return; }
  const list = load(LSK.votes, []); const v = list.find(x=>x.id===id); if(!v){ toast('æŠ•ç¥¨ä¸å­˜åœ¨','danger'); return; }
  if(v.status!=='OPEN'){ toast('æ­¤æŠ•ç¥¨å·²é—œé–‰','danger'); return; }
  const me = getUser()||{};
  if((v.responses||[]).some(r=>r.email===me.email)){ toast('æ‚¨å·²æŠ•éç¥¨','warning'); return; }
  const map = v.options.map((o,i)=>`${i+1}. ${o}`).join('\n');
  const pickStr = prompt(`è«‹è¼¸å…¥é¸é …åºè™Ÿï¼š\n${map}`); if(!pickStr) return;
  const idx = Number(pickStr)-1;
  if(!Number.isInteger(idx) || idx<0 || idx>=v.options.length){ toast('åºè™Ÿä¸æ­£ç¢º','danger'); return; }
  const note = prompt('é™„è¨»ï¼ˆå¯ç•™ç©ºï¼‰')||'';
  v.responses = v.responses||[];
  v.responses.push({email:me.email, name:me.name, role, choice:idx, note, time:new Date().toLocaleString()});
  save(LSK.votes, list);
  toast('æŠ•ç¥¨å®Œæˆï¼ˆDemoï¼‰'); renderTabContent(); renderCards();
}
function viewVote(id){
  const list = load(LSK.votes, []); const v = list.find(x=>x.id===id); if(!v) return;
  const counts = Array(v.options.length).fill(0);
  (v.responses||[]).forEach(r=>{ if(Number.isInteger(r.choice)) counts[r.choice]++; });
  const total = counts.reduce((a,b)=>a+b,0);
  const lines = v.options.map((opt,i)=>`${opt}ï¼š${counts[i]} ç¥¨ï¼ˆ${total?Math.round(counts[i]*100/total):0}%ï¼‰`).join('\n');
  alert(`ã€${v.title}ã€‘\n${lines}\n\nç¸½ç¥¨æ•¸ï¼š${total}`);
}
function closeVote(id){
  const role = getRole();
  if(!(role==='committee' || role==='admin')){ toast('åƒ…ç®¡å§”æœƒèˆ‡ç®¡ç†å“¡å¯é—œé–‰æŠ•ç¥¨','danger'); return; }
  const list = load(LSK.votes, []); const v = list.find(x=>x.id===id); if(!v) return;
  if(v.status==='CLOSED'){ toast('å·²æ˜¯é—œé–‰ç‹€æ…‹','warning'); return; }
  if(confirm('ç¢ºå®šé—œé–‰æ­¤æŠ•ç¥¨ï¼Ÿ')){
    v.status='CLOSED'; save(LSK.votes, list); toast('å·²é—œé–‰ï¼ˆDemoï¼‰'); renderTabContent(); renderCards();
  }
}

/* ===== ç·Šæ€¥é€šå ± ===== */
function openSOS(){
  if(!isLoggedIn()){ ensureAuth(); return; }
  if(!(getRole()==='committee' || getRole()==='admin')){ toast('åƒ…ç®¡å§”æœƒèˆ‡ç®¡ç†å“¡å¯ä½¿ç”¨','danger'); return; }
  toast('å·²é€å‡ºç·Šæ€¥é€šå ±ï¼ˆDemoï¼‰','danger');
}

/* ===== ç™»å…¥/è¨»å†Šï¼ˆå« admin ç›´æ¥å°å‘å¾Œå°ï¼‰ ===== */
let authMode='login';
function switchAuth(mode){
  authMode=mode;
  document.getElementById('authTitle').textContent=(mode==='login'?'ç™»å…¥':'è¨»å†Š');
  document.getElementById('loginForm').classList.toggle('d-none',mode!=='login');
  document.getElementById('registerForm').classList.toggle('d-none',mode!=='register');
  document.getElementById('switchAuthBtn').textContent=(mode==='login'?'åˆ‡æ›åˆ°è¨»å†Š':'åˆ‡æ›åˆ°ç™»å…¥');
}
function toggleAuth(){ switchAuth(authMode==='login'?'register':'login'); }

function handleLogin(){
  const email=document.getElementById('loginEmail').value.trim();
  const pwd=document.getElementById('loginPwd').value.trim();
  const role=document.getElementById('loginRole')?.value || 'resident';
  const vendorName = document.getElementById('loginVendor')?.value.trim();
  if(!email || pwd.length<6){ toast('è«‹è¼¸å…¥æ­£ç¢º Email èˆ‡è‡³å°‘ 6 ç¢¼å¯†ç¢¼','danger'); return; }
  const name=(email==='test@example.com'&&pwd==='123456')?'æ¸¬è©¦ç”¨æˆ¶':email.split('@')[0];

  setUser({email,name, role, vendorName: role==='vendor' ? (vendorName||name) : undefined});

  if(role==='admin'){ window.location.href='backend.html'; return; } // ç®¡ç†å“¡å°å¾Œå°

  updateAuthUI();

  // é—œæ‰ç™»å…¥ Modal
  const modalEl=document.getElementById('authModal');
  let m=bootstrap.Modal.getInstance(modalEl); if(!m) m=new bootstrap.Modal(modalEl); m.hide();

  toast('ç™»å…¥æˆåŠŸ'); // ä¸€å®šæç¤º

  if(pendingTab){ const t=pendingTab; pendingTab=null; gotoTab(t); }
}
function handleRegister(){
  const email=document.getElementById('regEmail').value.trim();
  const name=document.getElementById('regName').value.trim();
  const pwd=document.getElementById('regPwd').value.trim();
  const role=document.getElementById('regRole')?.value || 'resident';
  const vendorName = document.getElementById('regVendor')?.value.trim();
  if(!email || !name || pwd.length<6){ toast('è«‹å®Œæ•´å¡«å¯«ï¼Œå¯†ç¢¼è‡³å°‘ 6 ç¢¼','danger'); return; }

  setUser({email,name, role, vendorName: role==='vendor' ? (vendorName||name) : undefined});

  if(role==='admin'){ window.location.href='backend.html'; return; } // ç®¡ç†å“¡å°å¾Œå°

  updateAuthUI();
  bootstrap.Modal.getInstance(document.getElementById('authModal'))?.hide();

  toast('è¨»å†ŠæˆåŠŸï¼Œå·²ç™»å…¥');

  if(pendingTab){ const t=pendingTab; pendingTab=null; gotoTab(t); }
}
function logout(){ clearUser(); updateAuthUI(); toast('å·²ç™»å‡ºï¼Œå›åˆ°è©¦ç”¨æ¨¡å¼ï¼ˆåƒ…ç€è¦½ï¼‰','warning'); }

/* å€‹è³‡ Modalï¼ˆè¼‰å…¥/å„²å­˜ï¼›å«æˆ¿è™Ÿç¶å®šï¼‰ */
document.getElementById('profileModal')?.addEventListener('show.bs.modal', () => {
  const u = getUser() || {};
  document.getElementById('pfEmail').value = u.email || '';
  document.getElementById('pfName').value  = u.name  || '';
  document.getElementById('pfRoom').value  = u.room  || '';
});
function saveProfile(){
  const u = getUser() || {};
  const name = document.getElementById('pfName').value.trim();
  const room = document.getElementById('pfRoom').value.trim();
  setUser({ ...u, name, room });
  updateAuthUI();
  bootstrap.Modal.getInstance(document.getElementById('profileModal'))?.hide();
  toast('å·²æ›´æ–°è³‡æ–™ï¼');
}

/* å¿˜è¨˜å¯†ç¢¼ï¼ˆDemoï¼‰ */
document.getElementById('resetPwdModal')?.addEventListener('show.bs.modal', () => {
  const u = getUser() || {};
  document.getElementById('fpEmail').value = u.email || '';
});
function sendReset(){
  const email = document.getElementById('fpEmail').value.trim();
  if(!email){ toast('è«‹è¼¸å…¥ Email','danger'); return; }
  bootstrap.Modal.getInstance(document.getElementById('resetPwdModal'))?.hide();
  toast(`å·²å¯„å‡ºé‡è¨­å¯†ç¢¼é€£çµè‡³ï¼š${email}ï¼ˆDemo æ¨¡æ“¬ï¼‰`);
}

/* Chatbot */
const cbPanel = document.getElementById('cbPanel');
const cbBody  = document.getElementById('cbBody');
const cbInput = document.getElementById('cbInput');
function toggleChat(open){
  cbPanel.style.display = open ? 'block' : 'none';
  if(open){
    if(!cbBody.dataset.init){
      cbBody.dataset.init = '1';
      botSay('æ‚¨å¥½ï¼Œæˆ‘æ˜¯æ™ºèƒ½å®¢æœã€‚æœªç™»å…¥æœƒå…ˆå¸¶æ‚¨ç™»å…¥å†å›åˆ°åŸé ã€‚');
    }
    setTimeout(()=>cbInput.focus(), 50);
  }
}
function sendQuick(text){ cbInput.value = text; sendChat(); }
function sendChat(){
  const text = (cbInput.value || '').trim();
  if(!text) return;
  addMsg(text, 'me'); cbInput.value = '';
  setTimeout(()=> botSay( replyFor(text) ), 200);
}
function addMsg(text, who='bot'){
  const row = document.createElement('div');
  row.className = 'cb-msg ' + (who==='me' ? 'me' : 'bot');
  row.innerHTML = `<div class="bubble">${escapeHtml(text)}</div>`;
  cbBody.appendChild(row); cbBody.scrollTop = cbBody.scrollHeight;
}
function botSay(text){ addMsg(text, 'bot'); }
function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[m]); }
function replyFor(q){
  const routes = [
    { k: /(ä½æˆ¶|æˆ¶ç±|ä½å®¶)/, tab:'resident', ans:'ç‚ºæ‚¨æ‰“é–‹ã€Œä½æˆ¶è³‡æ–™ã€ã€‚' },
    { k: /(ä¸»å§”|æ¸…æ½”|äººå“¡)/, tab:'staff', ans:'ç‚ºæ‚¨æ‰“é–‹ã€Œä¸»å§”ã€æ¸…æ½”äººå“¡è³‡æ–™ã€ã€‚' },
    { k: /(è¨ªå®¢|å‡ºå…¥|ä¾†è³“)/, tab:'visitor', ans:'ç‚ºæ‚¨æ‰“é–‹ã€Œè¨ªå®¢ç´€éŒ„ã€ã€‚' },
    { k: /(ç®¡ç†è²»|ç¹³è²»|è²»ç”¨)/, tab:'fee', ans:'ç®¡ç†è²»å¯åœ¨ã€Œç®¡ç†è²»ã€åˆ†é æŸ¥è©¢ã€‚' },
    { k: /(å…¬å‘Š|åœæ°´|é€šçŸ¥)/, tab:'announcement', ans:'æœ€æ–°æ¶ˆæ¯åœ¨ã€Œç¤¾å€å…¬å‘Šã€ã€‚' },
    { k: /(æŠ•ç¥¨|è¡¨æ±º|å…¬æŠ•)/, tab:'vote', ans:'ç‚ºæ‚¨æ‰“é–‹ã€Œç¤¾å€æŠ•ç¥¨ã€ã€‚' },
    { k: /(æ´»å‹•|è¡Œç¨‹|æ™‚ç¨‹)/, tab:'activity', ans:'æ´»å‹•è³‡è¨Šåœ¨ã€Œç¤¾å€æ´»å‹•æ™‚ç¨‹ã€ã€‚' },
    { k: /(å ±ä¿®|ç¶­ä¿®ç”³è«‹|ä¿®ç¹•)/, tab:'repair', ans:'å ±ä¿®å¯åœ¨ã€Œå ±ä¿®ç”³è«‹ã€é€å‡ºã€‚' },
    { k: /(ä¿é¤Š|ç¶­è­·|ç¶­ä¿®ç´€éŒ„)/, tab:'maintenance', ans:'ç¶­ä¿®èˆ‡ä¿é¤Šè¨˜éŒ„åœ¨æ­¤åˆ†é ã€‚' },
    { k: /(å®¢æœ|å•ç­”|æå•)/, tab:'qa', ans:'å¸¸è¦‹å•é¡Œåœ¨ã€Œå®¢æœå•ç­”ã€ã€‚' },
    { k: /(æœƒè­°|ç´€éŒ„|æ±ºè­°)/, tab:'meeting', ans:'æœƒè­°ç›¸é—œåœ¨ã€Œæœƒè­°ç´€éŒ„ã€ã€‚' },
    { k: /(è²¡å‹™æ”¯å‡º|å ±éŠ·|æ”¯å‡º)/, tab:'expenditure', ans:'æ”¯å‡ºæ˜ç´°åœ¨ã€Œè²¡å‹™æ”¯å‡ºã€ã€‚' },
    { k: /(ä¿¡ä»¶|åŒ…è£¹|å–ä»¶)/, tab:'parcel', ans:'æ”¶ç™¼ä»¶åœ¨ã€Œä¿¡ä»¶åŒ…è£¹ã€ã€‚' },
  ];
  for(const r of routes){
    if(r.k.test(q)){
      if(!ensureAuth(r.tab)) return 'è«‹å…ˆç™»å…¥ï¼Œç™»å…¥å¾Œæœƒè‡ªå‹•å¸¶æ‚¨å›åˆ°è©²åˆ†é ã€‚';
      setTimeout(()=> gotoTab(r.tab), 150);
      return r.ans;
    }
  }
  if(/(ç™»å…¥|login)/i.test(q)){ switchAuth('login'); new bootstrap.Modal(document.getElementById('authModal')).show(); return 'å·²ç‚ºæ‚¨é–‹å•Ÿç™»å…¥è¦–çª—ã€‚'; }
  if(/(è¨»å†Š|register)/i.test(q)){ switchAuth('register'); new bootstrap.Modal(document.getElementById('authModal')).show(); return 'å·²ç‚ºæ‚¨é–‹å•Ÿè¨»å†Šè¦–çª—ã€‚'; }
  return 'æŠ±æ­‰æˆ‘æš«æ™‚è½ä¸æ‡‚ ğŸ˜… æ‚¨å¯ä»¥è¼¸å…¥ã€ŒæŠ•ç¥¨ã€ã€ã€Œå ±ä¿®ã€ã€ã€Œç®¡ç†è²»ã€æˆ–é»ä¸Šæ–¹å°è¦½ã€‚';
}

/* åˆå§‹åŒ– */
document.addEventListener('DOMContentLoaded', () => {
  renderCards(); updateAuthUI();

  // vendor é¡¯ç¤ºå…¬å¸åç¨±æ¬„ä½
  const toggleVendorInputs = (selId, wrapId)=>{
    const sel = document.getElementById(selId);
    const wrap = document.getElementById(wrapId);
    const toggle = ()=> wrap.classList.toggle('d-none', sel.value!=='vendor');
    sel.addEventListener('change', toggle); toggle();
  };
  toggleVendorInputs('loginRole','loginVendorWrap');
  toggleVendorInputs('regRole','regVendorWrap');

  // Enter ç›´æ¥ç™»å…¥
  document.getElementById('loginPwd')?.addEventListener('keydown', e=>{ if(e.key==='Enter') handleLogin(); });
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
