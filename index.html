<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ç¤¾å€å®¢æœç³»çµ± Demo Â· Material</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0a443f" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="icons/icon-192.png" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />

  <!-- Material Web -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:FILL@0..1" rel="stylesheet" />
  <script type="module">import 'https://esm.run/@material/web/all.js';</script>

  <style>
    :root{ --container-w: min(1140px, calc(100vw - 24px)); }
    html,body{height:100%}
    body{margin:0;font-family: Roboto, system-ui, -apple-system, "Segoe UI", Arial}

    /* App Bar */
    md-top-app-bar{ position: sticky; top: 0; z-index: 110; }

    /* Layout */
    .app-shell{display:flex;flex-direction:column;min-height:100%}
    .container{width:var(--container-w);margin-inline:auto}

    /* Cards */
    .grid{display:grid;gap:18px;grid-template-columns:repeat(auto-fill,minmax(280px,1fr))}
    .tile{
      position:relative;border-radius:18px;overflow:hidden;min-height:200px;color:#fff;
      background-size:cover;background-position:center;cursor:pointer;
      box-shadow:0 8px 24px rgba(0,0,0,.12);transition:transform .15s, box-shadow .15s, filter .15s
    }
    .tile:hover{ transform:translateY(-2px); box-shadow:0 14px 36px rgba(0,0,0,.18); filter:saturate(1.05); }
    .tile::before{content:"";position:absolute;inset:0;background:linear-gradient(180deg, rgba(0,0,0,.08), rgba(0,0,0,.28))}
    .tile > .inner{position:relative;padding:22px;text-shadow:0 1px 2px rgba(0,0,0,.45)}
    .tile .kicker{opacity:.95;font-weight:600;line-height:1.9}
    .badge{position:absolute;top:10px;right:10px;background:#FFD54F;color:#2b2b2b;border-radius:999px;padding:4px 10px;font-size:12px;font-weight:700;box-shadow:0 2px 6px rgba(0,0,0,.25)}
    .badge.danger{ background:#EF5350;color:#fff }

    /* Panel & Table */
    .panel{border-radius:16px;box-shadow:0 6px 20px rgba(0,0,0,.10);background:#fff}
    .panel-body{padding:18px}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{ text-align:left;background:#F4F6F8;border-bottom:1px solid #e7eaee;padding:10px 12px;font-weight:700 }
    tbody td{padding:10px 12px;border-bottom:1px solid #eef1f4}
    tbody tr:hover{background:#fafbfd}

    /* Banner */
    #bannerBox{margin:14px auto;width:var(--container-w)}
    .banner{padding:12px 14px;border-radius:12px;background:#fde7e9;color:#9f2d2f;border:1px solid #f5c6cb}

    /* Chatbot */
    .cb-wrap{ position:fixed; right:20px; bottom:max(20px, env(safe-area-inset-bottom)); z-index:1050; font-family: Roboto, system-ui,-apple-system,"Segoe UI",Arial; }
    .cb-btn{ min-width:120px; height:72px; border-radius:36px; display:flex; align-items:center; justify-content:center; gap:8px; background:#0a443f; color:#fff; border:none; box-shadow:0 10px 25px rgba(0,0,0,.25); cursor:pointer; font-size:18px; font-weight:500; }
    .cb-btn .icon{ font-size:24px; line-height:1; }
    .cb-panel{ width:320px; max-height:60vh; border-radius:14px; box-shadow:0 18px 45px rgba(0,0,0,.25); overflow:hidden; display:none; background:#fff; margin-bottom:10px; }
    .cb-header{ background:#0a443f; color:#fff; padding:10px 12px; display:flex; align-items:center; justify-content:space-between; }
    .cb-close{ background:transparent; border:0; color:#fff; font-size:22px; line-height:1; cursor:pointer }
    .cb-body{ padding:10px; height:280px; overflow:auto; background:#f7f8fa; }
    .cb-msg{ display:flex; margin-bottom:8px; }
    .cb-msg.bot .bubble{ background:#fff; border:1px solid #e5e7eb; color:#111; }
    .cb-msg.me{ justify-content:flex-end; }
    .cb-msg.me .bubble{ background:#0a443f; color:#fff; }
    .bubble{ padding:8px 10px; border-radius:12px; max-width:80%; font-size:14px; }
    .cb-footer{ display:flex; gap:6px; padding:10px; background:#fff; border-top:1px solid #eee; }
    .cb-footer input{ flex:1; }
    .cb-suggest{ display:flex; flex-wrap:wrap; gap:6px; padding:8px 10px; background:#f7f8fa; border-top:1px solid #eee; }
    .cb-chip{ font-size:12px; border:1px solid #e5e7eb; background:#fff; border-radius:999px; padding:4px 8px; cursor:pointer; }
    @media (max-width:420px){ .cb-panel{ width:calc(100vw - 24px); right:12px; bottom:84px; } }

    /* Right area in app bar */
    .toolbar-right{display:flex;align-items:center;gap:10px}
    md-text-button[quiet]{--md-sys-color-primary: #2b2b2b}

    /* Install FAB */
    #installCta{ position:fixed; right:16px; bottom: calc(max(20px, env(safe-area-inset-bottom)) + 120px); z-index:1200; display:none; }
    @media (max-width: 420px){ #installCta{ right:12px; bottom: calc(env(safe-area-inset-bottom) + 132px); } }
  </style>
</head>
<body class="app-shell">

  <!-- ===== Top App Bar + ä¸‹æ‹‰é¸å–® ===== -->
  <md-top-app-bar id="topbar">
    <div slot="navigationIcon" style="padding-left:6px"><span class="material-symbols-outlined">apartment</span></div>
    <div slot="headline" style="font-weight:900;letter-spacing:.4px">ç¤¾å€å®¢æœç³»çµ±</div>

    <!-- ä½æˆ¶èˆ‡äººå“¡ -->
    <md-text-button id="mA_btn" slot="end">ğŸ &nbsp;ä½æˆ¶èˆ‡äººå“¡</md-text-button>
    <md-menu id="mA" anchor="mA_btn">
      <md-menu-item id="mA_res"><div slot="headline">ä½æˆ¶è³‡æ–™</div></md-menu-item>
      <md-menu-item id="mA_staff"><div slot="headline">ä¸»å§”ã€æ¸…æ½”äººå“¡è³‡æ–™</div></md-menu-item>
      <md-menu-item id="mA_visit"><div slot="headline">è¨ªå®¢ç´€éŒ„</div></md-menu-item>
    </md-menu>

    <!-- è²¡å‹™èˆ‡ç®¡ç† -->
    <md-text-button id="mB_btn" slot="end">ğŸ’°&nbsp;è²¡å‹™èˆ‡ç®¡ç†</md-text-button>
    <md-menu id="mB" anchor="mB_btn">
      <md-menu-item id="mB_fee"><div slot="headline">ç®¡ç†è²»</div></md-menu-item>
      <md-menu-item id="mB_exp"><div slot="headline">è²¡å‹™æ”¯å‡º</div></md-menu-item>
    </md-menu>

    <!-- å…¬å‘Šèˆ‡æ´»å‹•ï¼ˆå«æœªè®€å¾½ç« ï¼‰ -->
    <md-badge id="annBadge" slot="end" value="0" style="--md-badge-container-color:#EF5350;--md-badge-label-color:#fff">
      <md-text-button id="mC_btn">ğŸ“¢&nbsp;å…¬å‘Šèˆ‡æ´»å‹•</md-text-button>
    </md-badge>
    <md-menu id="mC" anchor="mC_btn">
      <md-menu-item id="mC_ann"><div slot="headline">ç¤¾å€å…¬å‘Š</div></md-menu-item>
      <md-menu-item id="mC_vote"><div slot="headline">ç¤¾å€æŠ•ç¥¨</div></md-menu-item>
      <md-menu-item id="mC_act"><div slot="headline">ç¤¾å€æ´»å‹•æ™‚ç¨‹</div></md-menu-item>
      <md-menu-item id="mC_meet"><div slot="headline">æœƒè­°ç´€éŒ„</div></md-menu-item>
    </md-menu>

    <!-- ç¶­ä¿®èˆ‡å®¢æœ -->
    <md-text-button id="mD_btn" slot="end">ğŸ› ï¸&nbsp;ç¶­ä¿®èˆ‡å®¢æœ</md-text-button>
    <md-menu id="mD" anchor="mD_btn">
      <md-menu-item id="mD_rep"><div slot="headline">å ±ä¿®ç”³è«‹</div></md-menu-item>
      <md-menu-item id="mD_mai"><div slot="headline">ç¶­ä¿®ã€ä¿é¤Šç´€éŒ„</div></md-menu-item>
      <md-menu-item id="mD_qa"><div slot="headline">å®¢æœå•ç­”</div></md-menu-item>
    </md-menu>

    <!-- ä¿¡ä»¶åŒ…è£¹ -->
    <md-text-button id="mE_btn" slot="end">ğŸ“¦&nbsp;ä¿¡ä»¶åŒ…è£¹</md-text-button>
    <md-menu id="mE" anchor="mE_btn">
      <md-menu-item id="mE_parcel"><div slot="headline">ä¿¡ä»¶åŒ…è£¹</div></md-menu-item>
    </md-menu>

    <!-- å³å´ï¼šSOS + å¸³è™Ÿå€ -->
    <div class="toolbar-right" slot="end">
      <md-filled-tonal-button id="sosBtn" style="display:none">âš ï¸&nbsp;ç·Šæ€¥é€šå ±</md-filled-tonal-button>
      <span id="authCta">
        <md-filled-button id="btnLogin">ç™»å…¥</md-filled-button>
        <md-outlined-button id="btnRegister">è¨»å†Š</md-outlined-button>
      </span>
      <span id="authUser" style="display:none">
        <md-text-button id="userBtn" quiet>
          <span id="authName">ä½¿ç”¨è€…</span>
          <span class="material-symbols-outlined" style="font-size:18px;margin-left:4px">expand_more</span>
        </md-text-button>
        <md-menu id="userMenu" anchor="userBtn">
          <md-menu-item disabled><div slot="headline" id="authMail">user@example.com</div></md-menu-item>
          <md-menu-item id="m_edit"><div slot="headline">ä¿®æ”¹è³‡æ–™</div></md-menu-item>
          <md-menu-item id="m_pwd"><div slot="headline">å¿˜è¨˜å¯†ç¢¼</div></md-menu-item>
          <md-divider></md-divider>
          <md-menu-item id="m_logout"><div slot="headline" style="color:#c62828">ç™»å‡º</div></md-menu-item>
        </md-menu>
      </span>
      <a id="linkBackend" href="backend.html" style="text-decoration:none"><md-text-button>ç¤¾å€ä½æˆ¶</md-text-button></a>
    </div>
  </md-top-app-bar>

  <!-- ===== Banner ===== -->
  <div id="bannerBox"></div>

  <!-- ===== Main ===== -->
  <main class="container" style="padding:22px 0 28px">
    <div style="margin:8px 0 18px"><h2 style="font-weight:900;letter-spacing:.3px;margin:0">åŠŸèƒ½èˆ‡æœå‹™</h2></div>
    <section id="feature-grid" class="grid" aria-live="polite"></section>
    <section class="panel" style="margin-top:18px"><div class="panel-body"><div id="tab-content"></div></div></section>
  </main>

  <!-- åªä¿ç•™ã€Œä¿®æ”¹è³‡æ–™ / å¿˜è¨˜å¯†ç¢¼ã€å°è©±æ¡†ï¼ˆç™»å…¥æ”¹èµ°ç¨ç«‹é ï¼‰ -->
  <md-dialog id="profileDialog"><div slot="headline">ä¿®æ”¹è³‡æ–™</div>
    <div slot="content">
      <md-outlined-text-field id="pfEmail" label="Emailï¼ˆä¸å¯ä¿®æ”¹ï¼‰" disabled style="width:100%"></md-outlined-text-field>
      <md-outlined-text-field id="pfName"  label="é¡¯ç¤ºåç¨±" style="width:100%;margin-top:10px"></md-outlined-text-field>
      <md-outlined-text-field id="pfRoom"  label="æˆ¿è™Ÿï¼ˆDemo ç¶å®šï¼šæ±ºå®šå¯è¦‹ä½æˆ¶è³‡æ–™ï¼‰" style="width:100%;margin-top:10px"></md-outlined-text-field>
    </div>
    <div slot="actions"><md-text-button dialogAction="close">å–æ¶ˆ</md-text-button><md-filled-button id="saveProfileBtn">å„²å­˜</md-filled-button></div>
  </md-dialog>

  <md-dialog id="resetDialog"><div slot="headline">å¿˜è¨˜å¯†ç¢¼</div>
    <div slot="content">
      <div style="font-size:12px;color:#6b7280;margin-bottom:8px">Demoï¼šæœƒæ¨¡æ“¬å¯„å‡ºé‡è¨­å¯†ç¢¼é€£çµè‡³æ‚¨çš„ Emailã€‚</div>
      <md-outlined-text-field id="fpEmail" label="Email" type="email" style="width:100%"></md-outlined-text-field>
    </div>
    <div slot="actions"><md-text-button dialogAction="close">å–æ¶ˆ</md-text-button><md-filled-button id="sendResetBtn">å¯„é€é‡è¨­ä¿¡</md-filled-button></div>
  </md-dialog>

  <md-snackbar id="snack"></md-snackbar>
  <md-fab id="installCta" label="å®‰è£ App" variant="secondary"><md-icon slot="icon">download</md-icon></md-fab>

  <!-- Chatbotï¼ˆçœç•¥æ¨£å¼é‡è¤‡è¨»è§£ï¼‰ -->
  <div class="cb-wrap" id="cbWrap">
    <div class="cb-panel" id="cbPanel" aria-live="polite">
      <div class="cb-header"><strong>æ™ºèƒ½å®¢æœ</strong><button class="cb-close" onclick="toggleChat(false)" aria-label="é—œé–‰">Ã—</button></div>
      <div class="cb-body" id="cbBody"></div>
      <div class="cb-suggest" id="cbSuggest">
        <span class="cb-chip" onclick="sendQuick('ä½æˆ¶è³‡æ–™')">ä½æˆ¶è³‡æ–™</span>
        <span class="cb-chip" onclick="sendQuick('ç®¡ç†è²»')">ç®¡ç†è²»</span>
        <span class="cb-chip" onclick="sendQuick('å ±ä¿®')">å ±ä¿®</span>
        <span class="cb-chip" onclick="sendQuick('ç¤¾å€å…¬å‘Š')">ç¤¾å€å…¬å‘Š</span>
        <span class="cb-chip" onclick="sendQuick('ä¿¡ä»¶åŒ…è£¹')">ä¿¡ä»¶åŒ…è£¹</span>
        <span class="cb-chip" onclick="sendQuick('æŠ•ç¥¨')">æŠ•ç¥¨</span>
      </div>
      <div class="cb-footer">
        <input id="cbInput" type="text" placeholder="è¼¸å…¥å•é¡Œï¼Œä¾‹å¦‚ï¼šå¦‚ä½•ç¹³ç®¡ç†è²»ï¼Ÿ" onkeydown="if(event.key==='Enter'){sendChat()}">
        <button class="cb-btn" style="height:40px;min-width:auto;padding:0 14px;border-radius:10px" onclick="sendChat()">é€å‡º</button>
      </div>
    </div>
    <button class="cb-btn" id="cbBtn" onclick="toggleChat(true)" aria-label="é–‹å•Ÿå®¢æœ">
      <span class="material-symbols-outlined icon">chat</span> å®¢æœæ©Ÿå™¨äºº
    </button>
  </div>

  <!-- ================== APP SCRIPT ================== -->
  <script>
  /* ========= å‡è³‡æ–™ ========= */
  const demoResidents=[{id:1,name:"ç‹å¤§æ˜",room:"A101",phone:"0912-345678",car:"ABC-1234",moveIn:"2021-09-01",family:"ç‹å¤ªå¤ªã€ç‹å°æ˜"},{id:2,name:"æ—å°ç¾",room:"A102",phone:"0922-222222",car:"XYZ-5678",moveIn:"2023-06-15",family:"æ—çˆ¸çˆ¸ã€æ—åª½åª½"}];
  const demoStaff=[{id:1,name:"æä¸»å§”",role:"ä¸»å§”",phone:"0933-111111"},{id:2,name:"é™³æ¸…æ½”",role:"æ¸…æ½”äººå“¡",phone:"0933-222222"}];
  const demoVisitors=[{id:1,name:"é™³è¨ªå®¢",idCard:"A123456789",room:"A101",in:"2025-08-22 10:00",out:"2025-08-22 11:00",note:"é€æ–‡ä»¶"}];
  const demoFees=[{id:1,room:"A101",amount:1200,due:"2025-09-10",paid:true,invoice:"INV20250801"},{id:2,room:"A102",amount:1200,due:"2025-09-10",paid:false,invoice:"INV20250802"}];
  const demoAnnouncements=[{id:1,title:"åœæ°´é€šçŸ¥",content:"8/25ä¸Šåˆ9~12é»åœæ°´ã€‚",time:"2025-08-20",author:"æä¸»å§”",attachment:""}];
  const demoActivities=[{id:1,name:"ä¸­ç§‹çƒ¤è‚‰",time:"2025-09-15 18:00",location:"ä¸­åº­",signup:"ç¾å ´å ±å",organizer:"ç‹å¤§æ˜"}];
  const demoMaintenances=[{id:1,equipment:"é›»æ¢¯",item:"å¹´åº¦ä¿é¤Š",time:"2025-08-10",handler:"ä¿é¤Šå…¬å¸",cost:8000,note:"æ­£å¸¸"}];
  const demoQA=[{id:1,room:"A101",q:"åƒåœ¾æ€éº¼åˆ†é¡ï¼Ÿ",a:"è«‹ä¾å…¬å‘Šåˆ†é¡",status:"å·²å›è¦†",time:"2025-08-19"}];
  const demoMeetings=[{id:1,topic:"è²¡å‹™å¯©æŸ¥",time:"2025-08-18",location:"æœƒè­°å®¤",participants:"ä¸»å§”ã€ä½æˆ¶ä»£è¡¨",record:"è¨è«–æ”¶æ”¯",resolution:"é€šé"}];
  const demoExpenditures=[{id:1,item:"æ¸…æ½”ç”¨å“",amount:1500,date:"2025-08-12",purpose:"å¤§æ¨“æ¸…æ½”",proof:"æ”¶æ“š"}];
  const demoParcels=[{id:1,receiver:"ç‹å¤§æ˜",room:"A101",code:"PKG12345",arrival:"2025-08-21 14:00",received:true}];
  const demoRepairs=[{id:'R_demo1',room:"A101",item:"æ°´é¾é ­æ¼æ°´",desc:"å»šæˆ¿æ°´é¾é ­æŒçºŒæ»´æ°´",time:"2025-08-21 10:20",status:"ASSIGNED",createdBy:"a101@demo",assigneeVendor:"æ°´é›»å°ç‹å­",photos:[],progress:[]}];
  const demoVotes=[{id:'V_demo1',title:'æ˜¯å¦æ±°æ›å¤§é–€æŒ‡ç´‹è¾¨è­˜ä¸»æ©Ÿï¼Ÿ',options:['åŒæ„','ä¸åŒæ„','ä¿ç•™ï¼Œéœ€æ›´å¤šè³‡è¨Š'],deadline:'2025-09-30 23:59',status:'OPEN',createdAt:'2025-08-20 09:00',createdBy:'committee@demo',responses:[]}];

  /* ========= localStorage & helpers ========= */
  const AUTH_KEY="demo_auth_user";
  const LSK={repairs:"kms_repairs",announcements:"kms_ann",fees:"kms_fees",votes:"kms_votes"};
  const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
  const load=(k,def)=>{try{const s=localStorage.getItem(k);return s?JSON.parse(s):def;}catch{return def;}}
  const getUser =()=>JSON.parse(localStorage.getItem(AUTH_KEY)||"null");
  const setUser =u=>localStorage.setItem(AUTH_KEY,JSON.stringify(u));
  const clearUser=()=>localStorage.removeItem(AUTH_KEY);
  const isLoggedIn=()=>!!localStorage.getItem(AUTH_KEY);
  const getRole =()=> (getUser()?.role)||"guest";
  const gid=(p)=> p+Math.random().toString(36).slice(2,8);
  let activeTab=null;

  // åˆå§‹ demo data
  if(!localStorage.getItem(LSK.repairs)) save(LSK.repairs,demoRepairs);
  if(!localStorage.getItem(LSK.announcements)) save(LSK.announcements,demoAnnouncements);
  if(!localStorage.getItem(LSK.fees)) save(LSK.fees,demoFees);
  if(!localStorage.getItem(LSK.votes)) save(LSK.votes,demoVotes);

  /* ========= æœªè®€/æœªæŠ• ========= */
  function annReadKey(){const email=getUser()?.email;return email?`ann_read_${email}`:null;}
  function getAnnReadSet(){const k=annReadKey();if(!k) return new Set(); const arr=load(k,[]); return new Set(arr.map(String));}
  function saveAnnReadSet(set){const k=annReadKey(); if(!k) return; localStorage.setItem(k,JSON.stringify([...set]));}
  function getUnreadCount(){ if(!isLoggedIn()) return 0; const anns=load(LSK.announcements,[]); const read=getAnnReadSet(); return anns.filter(a=>!read.has(String(a.id))).length; }
  function markAnnRead(id){ const set=getAnnReadSet(); set.add(String(id)); saveAnnReadSet(set); updateUnreadUI(); if(activeTab==='announcement') renderTabContent(); }
  function markAllAnnRead(){ const anns=load(LSK.announcements,[]); saveAnnReadSet(new Set(anns.map(a=>String(a.id)))); updateUnreadUI(); if(activeTab==='announcement') renderTabContent(); }
  function updateUnreadUI(){ const c=getUnreadCount(); document.getElementById('annBadge').setAttribute('value',String(c)); const showSOS=(getRole()==='committee'||getRole()==='admin'); document.getElementById('sosBtn').style.display=showSOS?'':'none'; if(!document.getElementById('feature-grid').classList.contains('d-none')) renderCards(); }
  function getUnvotedCount(){ if(!isLoggedIn()) return 0; const me=getUser()||{}; const list=load(LSK.votes,[]); return list.filter(v=>v.status==='OPEN'&&!(v.responses||[]).some(r=>r.email===me.email)).length; }

  /* ========= UI ========= */
  function toast(msg='å®Œæˆ',ms=2400){const s=document.getElementById('snack'); s.labelText=msg; s.open=true; setTimeout(()=>s.open=false,ms);}
  function banner(msg=''){const box=document.getElementById('bannerBox'); box.innerHTML = msg ? `<div class="banner">è¼‰å…¥å¡ç‰‡æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š${msg}</div>` : '';}

  /* ========= Cards ========= */
  function renderCards(){
    const grid=document.getElementById('feature-grid');
    try{
      const unread=getUnreadCount(), unvoted=getUnvotedCount();
      grid.innerHTML=`
        ${[
          ["resident","ä½æˆ¶è³‡æ–™","åŸºæœ¬è³‡æ–™ ï½œ ä½æˆ¶è¯çµ¡ ï½œ è»Šä½ ï½œ å®¶åº­æˆå“¡","https://images.unsplash.com/photo-1581091215367-59ab6b3d6321?q=80&w=1600&auto=format&fit=crop"],
          ["staff","ä¸»å§”ã€æ¸…æ½”äººå“¡è³‡æ–™","ä¸»å§” ï½œ æ¸…æ½”äººå“¡","https://images.unsplash.com/photo-1551836022-d5d88e9218df?q=80&w=1600&auto=format&fit=crop"],
          ["visitor","è¨ªå®¢ç´€éŒ„","è¨ªå®¢ç™»è¨˜ ï½œ åˆ°é›¢ç´€éŒ„","https://images.unsplash.com/photo-1517245386807-bb43f82c33c4?q=80&w=1600&auto=format&fit=crop"],
          ["fee","ç®¡ç†è²»","é‡‘é¡ ï½œ åˆ°æœŸæ—¥ ï½œ ç™¼ç¥¨","https://images.unsplash.com/photo-1454165804606-c3d57bc86b40?q=80&w=1600&auto=format&fit=crop"],
          ["announcement","ç¤¾å€å…¬å‘Š","åœæ°´åœé›» ï½œ å€å‹™é€šçŸ¥","https://images.unsplash.com/photo-1529336953121-ad5a0d43d0d2?q=80&w=1600&auto=format&fit=crop"],
          ["vote","ç¤¾å€æŠ•ç¥¨","ç¤¾å€ææ¡ˆ ï½œ ç·šä¸ŠæŠ•ç¥¨","https://images.unsplash.com/photo-1517048676732-d65bc937f952?q=80&w=1600&auto=format&fit=crop"],
          ["activity","ç¤¾å€æ´»å‹•æ™‚ç¨‹","æ´»å‹•è³‡è¨Š ï½œ å ±åæ–¹å¼","https://images.unsplash.com/photo-1529333166437-7750a6dd5a70?q=80&w=1600&auto=format&fit=crop"],
          ["repair","å ±ä¿®ç”³è«‹","ç·šä¸Šå ±ä¿® ï½œ é€²åº¦è¿½è¹¤","https://images.unsplash.com/photo-1503387762-592deb58ef4e?q=80&w=1600&auto=format&fit=crop"],
          ["maintenance","ç¶­ä¿®ã€ä¿é¤Šç´€éŒ„","è¨­å‚™ ï½œ é …ç›® ï½œ èŠ±è²»","https://images.unsplash.com/photo-1518779578993-ec3579fee39f?q=80&w=1600&auto=format&fit=crop"],
          ["qa","å®¢æœå•ç­”","æå•å›è¦† ï½œ è™•ç†ç‹€æ…‹","https://images.unsplash.com/photo-1525186402429-b4ff38bedbec?q=80&w=1600&auto=format&fit=crop"],
          ["meeting","æœƒè­°ç´€éŒ„","ä¸»é¡Œ ï½œ æ±ºè­°äº‹é …","https://images.unsplash.com/photo-1522071820081-009f0129c71c?q=80&w=1600&auto=format&fit=crop"],
          ["expenditure","è²¡å‹™æ”¯å‡º","é …ç›® ï½œ é‡‘é¡ ï½œ æ†‘è­‰","https://images.unsplash.com/photo-1521540216272-a50305cd4421?q=80&w=1600&auto=format&fit=crop"],
          ["parcel","ä¿¡ä»¶åŒ…è£¹","æ”¶ç™¼ä»¶ ï½œ å–ä»¶ç¢¼","https://images.unsplash.com/photo-1540573133985-87b6da6d54a9?q=80&w=1600&auto=format&fit=crop"]
        ].map(([key,title,items,bg])=>{
          const badge = key==='announcement'&&unread>0 ? `<div class="badge danger">æœªè®€ ${unread}</div>`
                      : key==='vote'&&unvoted>0 ? `<div class="badge">æœªæŠ• ${unvoted}</div>` : '';
          return `<article class="tile" style="background-image:url('${bg}')" onclick="gotoTab('${key}')">
                    ${badge}<div class="inner"><div style="font-size:20px;font-weight:900;letter-spacing:.3px">${title}</div>
                    <div class="kicker">${items}</div></div></article>`;
        }).join('')}`;
      banner('');
    }catch(err){console.error('[renderCards] fail:',err);grid.innerHTML='';banner(err.message||String(err));}
  }
  function backHome(){document.getElementById('feature-grid').classList.remove('d-none');document.getElementById('tab-content').innerHTML="";activeTab=null;renderCards();updateUnreadUI();banner('');}

  /* ========= Auth Gateï¼ˆæœªç™»å…¥å°å‘ auth.htmlï¼‰ ========= */
  function ensureAuth(redirectTab = null){
    if (isLoggedIn()) return true;
    const next = redirectTab
      ? `app.html?tab=${encodeURIComponent(redirectTab)}`
      : location.href;
    // æª”æ¡ˆåœ¨æ ¹ç›®éŒ„ â†’ ç›´æ¥æŒ‡å‘ auth.html
    location.href = `auth.html?next=${encodeURIComponent(next)}`;
    return false;
  }

  // å¡ç‰‡/é¸å–®æœƒå‘¼å« gotoTab â†’ é€™è£¡ä¿æŒæ ¹ç›®éŒ„çš„ app.html
  function gotoTab(key){
    if (!ensureAuth(key)) return;
    location.href = `app.html?tab=${encodeURIComponent(key)}`;
  }

  // å³ä¸Šè§’ç™»å…¥ / è¨»å†ŠæŒ‰éˆ•ï¼ˆæ ¹ç›®éŒ„ï¼‰
  document.getElementById('btnLogin').onclick = () => {
    location.href = `auth.html?next=${encodeURIComponent(location.href)}`;
  };
  document.getElementById('btnRegister').onclick = () => {
    location.href = `auth.html?next=${encodeURIComponent(location.href)}#register`;
  };
  // å¡ç‰‡/é¸å–® â†’ app.html å°æ‡‰åˆ†é 
  function gotoTab(key){ if(!ensureAuth(key)) return; location.href = `app.html?tab=${encodeURIComponent(key)}`; }

  /* ========= å¸³è™Ÿå€ ========= */
  function updateAuthUI(){
    const cta=document.getElementById('authCta'), userBox=document.getElementById('authUser');
    if(isLoggedIn()){
      const u=getUser()||{};
      cta.style.display='none'; userBox.style.display='';
      document.getElementById('authName').textContent=u.name||u.email||'ä½¿ç”¨è€…';
      document.getElementById('authMail').textContent=u.email||'user@example.com';
    }else{
      cta.style.display=''; userBox.style.display='none';
    }
    updateUnreadUI();
  }

  /* ========= æœå°‹ ========= */
  function withSearch(tableBlockHtml, placeholder='é—œéµå­—æœå°‹'){
    const id='tbl_'+Math.random().toString(36).slice(2,8);
    return `<div style="margin-bottom:8px"><md-outlined-text-field label="${placeholder}" style="width:100%" type="search" oninput="(function(el){const wrap=document.getElementById('${id}');if(!wrap)return;const trs=wrap.querySelectorAll('tbody tr');const key=el.value.trim().toLowerCase();trs.forEach(tr=>{tr.style.display=key===''||tr.textContent.toLowerCase().includes(key)?'':'none';});})(this)"></md-outlined-text-field></div><div id="${id}">${tableBlockHtml}</div>`;
  }

  /* ========= åˆ†é å…§å®¹ï¼ˆé¦–é ä¸‹æ–¹é è¦½ç”¨ï¼‰ ========= */
  function renderTabContent(){ document.getElementById('tab-content').innerHTML=''; }

  /* ========= å ±ä¿® / æŠ•ç¥¨ï¼ˆä¿ç•™çµ¦é¦–é  demo ç”¨ï¼‰ ========= */
  function createRepair(){ if(getRole()!=='resident'){toast('åƒ…ä½æˆ¶å¯æ–°å¢å ±ä¿®');return;} const room=getUser()?.room||prompt('æˆ¿è™Ÿï¼Ÿï¼ˆä¾‹å¦‚ A101ï¼‰'); if(!room) return; const item=prompt('å ±ä¿®é …ç›®ï¼Ÿï¼ˆä¾‹å¦‚ æ°´é¾é ­æ¼æ°´ï¼‰'); if(!item) return; const desc=prompt('æè¿°ï¼Ÿ')||''; const list=load(LSK.repairs,[]); list.unshift({id:gid('R_'),room,item,desc,time:new Date().toISOString().slice(0,16).replace('T',' '),status:'NEW',createdBy:getUser()?.email||'',assigneeVendor:'',photos:[],progress:[]}); save(LSK.repairs,list); toast('å ±ä¿®å·²é€å‡ºï¼ˆDemoï¼‰'); }
  function createVote(){ const role=getRole(); if(!(role==='committee'||role==='admin')){ toast('åƒ…ç®¡å§”æœƒèˆ‡ç®¡ç†å“¡å¯å»ºç«‹æŠ•ç¥¨'); return; } const title=prompt('æŠ•ç¥¨ä¸»é¡Œï¼Ÿ'); if(!title) return; const optsStr=prompt('é¸é …ï¼ˆä»¥é€—è™Ÿåˆ†éš”ï¼Œè‡³å°‘ 2 é …ï¼‰ï¼š','åŒæ„,ä¸åŒæ„'); if(!optsStr) return; const options=optsStr.split(',').map(s=>s.trim()).filter(Boolean); if(options.length<2){ toast('è‡³å°‘éœ€è¦ 2 å€‹é¸é …'); return; } const deadline=prompt('æˆªæ­¢æ™‚é–“ï¼ˆå¯ç•™ç©ºï¼‰ï¼Œä¾‹ï¼š2025-09-30 23:59')||''; const list=load(LSK.votes,[]); list.unshift({id:gid('V_'),title,options,deadline,status:'OPEN',createdAt:new Date().toISOString().slice(0,16).replace('T',' '),createdBy:getUser()?.email||'',responses:[]}); save(LSK.votes,list); toast('å·²å»ºç«‹æŠ•ç¥¨ï¼ˆDemoï¼‰'); renderCards(); }

  /* ========= Profile / Reset ========= */
  document.getElementById('m_edit').addEventListener('click', ()=>{ if(!ensureAuth()) return; const u=getUser()||{}; document.getElementById('pfEmail').value=u.email||''; document.getElementById('pfName').value=u.name||''; document.getElementById('pfRoom').value=u.room||''; document.getElementById('profileDialog').open=true; });
  document.getElementById('saveProfileBtn').addEventListener('click', ()=>{ const u=getUser()||{}; const name=document.getElementById('pfName').value.trim(); const room=document.getElementById('pfRoom').value.trim(); setUser({...u,name,room}); updateAuthUI(); document.getElementById('profileDialog').open=false; toast('å·²æ›´æ–°è³‡æ–™ï¼'); });
  document.getElementById('m_pwd').addEventListener('click', ()=>{ const u=getUser()||{}; document.getElementById('fpEmail').value=u.email||''; document.getElementById('resetDialog').open=true; });
  document.getElementById('sendResetBtn').addEventListener('click', ()=>{ const email=document.getElementById('fpEmail').value.trim(); if(!email){ toast('è«‹è¼¸å…¥ Email'); return; } document.getElementById('resetDialog').open=false; toast(`å·²å¯„å‡ºé‡è¨­å¯†ç¢¼é€£çµè‡³ï¼š${email}ï¼ˆDemo æ¨¡æ“¬ï¼‰`); });
  document.getElementById('m_logout').addEventListener('click', ()=>{ clearUser(); updateAuthUI(); toast('å·²ç™»å‡ºï¼Œå›åˆ°è©¦ç”¨æ¨¡å¼ï¼ˆåƒ…ç€è¦½ï¼‰'); });

  /* ========= Chatbot ========= */
  const cbPanel=document.getElementById('cbPanel'), cbBody=document.getElementById('cbBody'), cbInput=document.getElementById('cbInput');
  function toggleChat(open){ cbPanel.style.display=open?'block':'none'; if(open){ if(!cbBody.dataset.init){ cbBody.dataset.init='1'; botSay('æ‚¨å¥½ï¼Œæˆ‘æ˜¯æ™ºèƒ½å®¢æœã€‚æœªç™»å…¥æœƒå…ˆå¸¶æ‚¨ç™»å…¥å†å›åˆ°åŸé ã€‚'); } setTimeout(()=>cbInput.focus(),50); } }
  function sendQuick(text){ cbInput.value=text; sendChat(); }
  function sendChat(){ const text=(cbInput.value||'').trim(); if(!text) return; addMsg(text,'me'); cbInput.value=''; setTimeout(()=>botSay(replyFor(text)),200); }
  function addMsg(text,who='bot'){ const row=document.createElement('div'); row.className='cb-msg '+(who==='me'?'me':'bot'); row.innerHTML=`<div class="bubble">${text.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}</div>`; cbBody.appendChild(row); cbBody.scrollTop=cbBody.scrollHeight; }
  function botSay(text){ addMsg(text,'bot'); }
  function replyFor(q){
    const routes=[{k:/(ä½æˆ¶|æˆ¶ç±|ä½å®¶)/,tab:'resident',ans:'ç‚ºæ‚¨æ‰“é–‹ã€Œä½æˆ¶è³‡æ–™ã€ã€‚'},{k:/(ä¸»å§”|æ¸…æ½”|äººå“¡)/,tab:'staff',ans:'ç‚ºæ‚¨æ‰“é–‹ã€Œä¸»å§”ã€æ¸…æ½”äººå“¡è³‡æ–™ã€ã€‚'},{k:/(è¨ªå®¢|å‡ºå…¥|ä¾†è³“)/,tab:'visitor',ans:'ç‚ºæ‚¨æ‰“é–‹ã€Œè¨ªå®¢ç´€éŒ„ã€ã€‚'},{k:/(ç®¡ç†è²»|ç¹³è²»|è²»ç”¨)/,tab:'fee',ans:'ç®¡ç†è²»å¯åœ¨ã€Œç®¡ç†è²»ã€åˆ†é æŸ¥è©¢ã€‚'},{k:/(å…¬å‘Š|åœæ°´|é€šçŸ¥)/,tab:'announcement',ans:'æœ€æ–°æ¶ˆæ¯åœ¨ã€Œç¤¾å€å…¬å‘Šã€ã€‚'},{k:/(æŠ•ç¥¨|è¡¨æ±º|å…¬æŠ•)/,tab:'vote',ans:'ç‚ºæ‚¨æ‰“é–‹ã€Œç¤¾å€æŠ•ç¥¨ã€ã€‚'},{k:/(æ´»å‹•|è¡Œç¨‹|æ™‚ç¨‹)/,tab:'activity',ans:'æ´»å‹•è³‡è¨Šåœ¨ã€Œç¤¾å€æ´»å‹•æ™‚ç¨‹ã€ã€‚'},{k:/(å ±ä¿®|ç¶­ä¿®ç”³è«‹|ä¿®ç¹•)/,tab:'repair',ans:'å ±ä¿®å¯åœ¨ã€Œå ±ä¿®ç”³è«‹ã€é€å‡ºã€‚'},{k:/(ä¿é¤Š|ç¶­è­·|ç¶­ä¿®ç´€éŒ„)/,tab:'maintenance',ans:'ç¶­ä¿®èˆ‡ä¿é¤Šè¨˜éŒ„åœ¨æ­¤åˆ†é ã€‚'},{k:/(å®¢æœ|å•ç­”|æå•)/,tab:'qa',ans:'å¸¸è¦‹å•é¡Œåœ¨ã€Œå®¢æœå•ç­”ã€ã€‚'},{k:/(æœƒè­°|ç´€éŒ„|æ±ºè­°)/,tab:'meeting',ans:'æœƒè­°ç›¸é—œåœ¨ã€Œæœƒè­°ç´€éŒ„ã€ã€‚'},{k:/(è²¡å‹™æ”¯å‡º|å ±éŠ·|æ”¯å‡º)/,tab:'expenditure',ans:'æ”¯å‡ºæ˜ç´°åœ¨ã€Œè²¡å‹™æ”¯å‡ºã€ã€‚'},{k:/(ä¿¡ä»¶|åŒ…è£¹|å–ä»¶)/,tab:'parcel',ans:'æ”¶ç™¼ä»¶åœ¨ã€Œä¿¡ä»¶åŒ…è£¹ã€ã€‚'}];
    for(const r of routes){
      if(r.k.test(q)){
        if(!ensureAuth(r.tab)) return 'ç‚ºæ‚¨å¸¶åˆ°ç™»å…¥é â€¦';
        setTimeout(()=>gotoTab(r.tab),150);
        return r.ans;
      }
    }
    if(/(ç™»å…¥|login)/i.test(q)){ location.href = `auth.html?next=${encodeURIComponent(location.href)}`; return 'å‰å¾€ç™»å…¥é â€¦'; }
    if(/(è¨»å†Š|register)/i.test(q)){ location.href = `auth.html?next=${encodeURIComponent(location.href)}#register`; return 'å‰å¾€è¨»å†Šé â€¦'; }
    return 'æŠ±æ­‰æˆ‘æš«æ™‚è½ä¸æ‡‚ ğŸ˜… æ‚¨å¯ä»¥è¼¸å…¥ã€ŒæŠ•ç¥¨ã€ã€ã€Œå ±ä¿®ã€ã€ã€Œç®¡ç†è²»ã€æˆ–é»ä¸Šæ–¹å°è¦½ã€‚';
  }

  /* ========= PWAï¼ˆSW + å®‰è£ï¼‰ ========= */
  (function(){
    const fab = document.getElementById('installCta');
    let deferredPrompt = null;

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js', { scope: './' }).catch(console.warn);
    }

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      if (fab) fab.style.display = '';
    });

    fab?.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      try { await deferredPrompt.userChoice; } catch {}
      deferredPrompt = null;
      fab.style.display = 'none';
    });

    window.addEventListener('appinstalled', () => {
      deferredPrompt = null;
      if (fab) fab.style.display = 'none';
    });
  })();


  /* ========= ç¶å®šä¸‹æ‹‰é–‹å•Ÿ ========= */
  function bindDropdown(btnId, menuId){
    const btn=document.getElementById(btnId);
    const menu=document.getElementById(menuId);
    if(menu && btn){ menu.anchorElement = btn; btn.addEventListener('click', ()=>{ menu.open = !menu.open; }); }
  }
  ['A','B','C','D','E'].forEach(x=>bindDropdown(`m${x}_btn`,`m${x}`));

  /* ========= Menu -> Tabs ========= */
  const click=(id,fn)=>document.getElementById(id).addEventListener('click',fn);
  click('mA_res', ()=> gotoTab('resident'));
  click('mA_staff',()=> gotoTab('staff'));
  click('mA_visit',()=> gotoTab('visitor'));
  click('mB_fee', ()=> gotoTab('fee'));
  click('mB_exp', ()=> gotoTab('expenditure'));
  click('mC_ann',()=> gotoTab('announcement'));
  click('mC_vote',()=> gotoTab('vote'));
  click('mC_act', ()=> gotoTab('activity'));
  click('mC_meet',()=> gotoTab('meeting'));
  click('mD_rep', ()=> gotoTab('repair'));
  click('mD_mai', ()=> gotoTab('maintenance'));
  click('mD_qa',  ()=> gotoTab('qa'));
  click('mE_parcel', ()=> gotoTab('parcel'));

  /* ========= å³ä¸Šè§’ç™»å…¥ / è¨»å†ŠæŒ‰éˆ• â†’ auth.html ========= */
  document.getElementById('btnLogin').addEventListener('click', ()=>{
    location.href = `auth.html?next=${encodeURIComponent(location.href)}`;
  });
  document.getElementById('btnRegister').addEventListener('click', ()=>{
    location.href = `auth.html?next=${encodeURIComponent(location.href)}#register`;
  });

  /* ========= SOS ========= */
  document.getElementById('sosBtn').addEventListener('click', ()=>{
    if(!isLoggedIn()){ ensureAuth(); return; }
    if(!(getRole()==='committee'||getRole()==='admin')){ toast('åƒ…ç®¡å§”æœƒèˆ‡ç®¡ç†å“¡å¯ä½¿ç”¨'); return; }
    toast('å·²é€å‡ºç·Šæ€¥é€šå ±ï¼ˆDemoï¼‰');
  });

  /* ========= å•Ÿå‹• ========= */
  window.addEventListener('DOMContentLoaded', ()=>{ renderCards(); updateAuthUI(); });
  </script>
</body>
</html>
