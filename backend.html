<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ç¤¾å€å®¢æœç³»çµ± Â· ç®¡ç†å¾Œå°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0a443f" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="icons/icon-192.png" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />

  <!-- Material Web -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:FILL@0..1" rel="stylesheet" />
  <script type="module">import 'https://esm.run/@material/web/all.js';</script>

  <style>
    :root{ --container-w: min(1140px, calc(100vw - 24px)); }
    html,body{height:100%}
    body{margin:0;font-family: Roboto, system-ui, -apple-system, "Segoe UI", Arial;}

    /* App Bar */
    md-top-app-bar{ position: sticky; top: 0; z-index: 110; }

    /* Layout */
    .app-shell{display:flex;flex-direction:column;min-height:100%}
    .container{width:var(--container-w);margin-inline:auto}

    /* Grid Cardsï¼ˆèˆ‡å‰å°ä¸€è‡´é¢¨æ ¼ï¼‰ */
    .grid{display:grid;gap:18px;grid-template-columns:repeat(auto-fill,minmax(280px,1fr))}
    .tile{
      position:relative;border-radius:18px;overflow:hidden;min-height:200px;color:#fff;
      background-size:cover;background-position:center;cursor:pointer;
      box-shadow:0 8px 24px rgba(0,0,0,.12);transition:transform .15s, box-shadow .15s, filter .15s
    }
    .tile:hover{ transform:translateY(-2px); box-shadow:0 14px 36px rgba(0,0,0,.18); filter:saturate(1.05); }
    .tile::before{content:"";position:absolute;inset:0;background:linear-gradient(180deg, rgba(0,0,0,.08), rgba(0,0,0,.28))}
    .tile > .inner{position:relative;padding:22px;text-shadow:0 1px 2px rgba(0,0,0,.45)}
    .tile .kicker{opacity:.95;font-weight:600;line-height:1.9}
    .badge{position:absolute;top:10px;right:10px;background:#FFD54F;color:#2b2b2b;border-radius:999px;padding:6px 10px;font-weight:700;box-shadow:0 8px 24px rgba(0,0,0,.14)}
    .tile .title{font-size:22px;font-weight:900;letter-spacing:.3px;margin:4px 0 8px}
    .tile .items{line-height:1.9;font-weight:600;opacity:.95}

    /* é¢æ¿ï¼ˆå…§é å®¹å™¨ï¼‰ */
    .panel{background:#fff;border-radius:18px;box-shadow:0 8px 28px rgba(0,0,0,.08)}
    .panel-body{padding:18px}

    /* å®‰è£ FAB ä½ç½®ï¼ˆèˆ‡å‰å°ä¸€è‡´ï¼‰ */
    #installCta{ position:fixed; right:16px; bottom: calc(env(safe-area-inset-bottom) + 132px); z-index:1200; display:none; }
    @media (max-width: 420px){ #installCta{ right:12px; bottom: calc(env(safe-area-inset-bottom) + 96px); } }

    /* å°å¾½ç«  */
    .chip{display:inline-flex;align-items:center;gap:6px;border-radius:999px;background:#eef3f3;color:#0a443f;padding:6px 10px;font-weight:700}
    .muted{opacity:.66}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 12px;border-bottom:1px solid #eee}
    th{text-align:left;font-weight:800}
    tbody tr:hover{background:#fafafa}
  </style>
</head>
<body class="app-shell">

  <!-- ===== Top App Barï¼ˆèˆ‡å‰å°ä¸€è‡´é¢¨æ ¼ï¼‰ ===== -->
  <md-top-app-bar id="topbar">
    <div slot="navigationIcon" style="padding-left:6px"><span class="material-symbols-outlined">apartment</span></div>
    <div slot="headline" style="font-weight:900;letter-spacing:.4px">ç¤¾å€å®¢æœç³»çµ± Â· ç®¡ç†å¾Œå°</div>

    <!-- å›å‰å° -->
    <md-icon-button id="goFront" slot="actionItems" aria-label="å›å‰å°" title="å›å‰å°" onclick="location.href='index.html'">
      <span class="material-symbols-outlined">home</span>
    </md-icon-button>

    <!-- ä½¿ç”¨è€…é¸å–® -->
    <md-menu id="userMenu" anchor="userBtn">
      <md-menu-item disabled>
        <div slot="headline" id="authName">ä½¿ç”¨è€…</div>
        <div slot="supporting-text" id="authMail" class="muted">user@example.com</div>
      </md-menu-item>
      <md-divider></md-divider>
      <md-menu-item onclick="logout()">
        <span slot="start" class="material-symbols-outlined">logout</span>
        <div slot="headline">ç™»å‡º</div>
      </md-menu-item>
    </md-menu>
    <md-icon-button id="userBtn" slot="actionItems" aria-label="å¸³è™Ÿ" title="å¸³è™Ÿ" onclick="userMenu.show()">
      <span class="material-symbols-outlined">account_circle</span>
    </md-icon-button>
  </md-top-app-bar>

  <!-- ===== Main ===== -->
  <main class="container" style="padding:22px 0 28px">
    <div style="margin:8px 0 18px">
      <h2 style="font-weight:900;letter-spacing:.3px;margin:0;display:flex;gap:12px;align-items:center">
        ç®¡ç†é …ç›®
        <span class="chip"><span class="material-symbols-outlined" style="font-size:18px">verified_user</span> Admin</span>
      </h2>
      <div class="muted" style="margin-top:6px">è«‹é¸æ“‡ä¸€å€‹ç®¡ç†æ¨¡çµ„ï¼Œæˆ–ä½¿ç”¨ä¸‹æ–¹å…§é å·¥å…·åˆ—ã€‚</div>
    </div>

    <!-- æ¨¡çµ„å¡ç‰‡ï¼ˆèˆ‡å‰å°ä¸€è‡´çµæ§‹ï¼‰ -->
    <section id="feature-grid" class="grid" aria-live="polite">
      <div class="tile" style="background-image:url('https://images.unsplash.com/photo-1581090463728-28b1b3a4f50b?q=80&w=1400&auto=format&fit=crop')" onclick="gotoTab('announcement')">
        <div class="badge">å…¬å‘Š / æŠ•ç¥¨</div>
        <div class="inner">
          <div class="kicker">ğŸ—³ï¸ å…¬å‘Š / æŠ•ç¥¨</div>
          <div class="title">ç¤¾å€å…¬å‘Šèˆ‡æŠ•ç¥¨</div>
          <div class="items">æ–°å¢å…¬å‘Š Â· ç·¨è¼¯ Â· åˆªé™¤ Â· æŠ•ç¥¨çµæœ</div>
        </div>
      </div>

      <div class="tile" style="background-image:url('https://images.unsplash.com/photo-1581092795360-fd1ca04f0952?q=80&w=1400&auto=format&fit=crop')" onclick="gotoTab('maintenance')">
        <div class="badge">ç¶­ä¿® / å®¢æœ</div>
        <div class="inner">
          <div class="kicker">ğŸ› ï¸ ç¶­ä¿® / å®¢æœ</div>
          <div class="title">è¨­å‚™ç¶­è­·èˆ‡å®¢æœå–®</div>
          <div class="items">æ–°å¢ç¶­ä¿® Â· æŒ‡æ´¾ Â· é€²åº¦ Â· é—œå–®</div>
        </div>
      </div>

      <div class="tile" style="background-image:url('https://images.unsplash.com/photo-1554224155-8d04cb21cd6c?q=80&w=1400&auto=format&fit=crop')" onclick="gotoTab('finance')">
        <div class="badge">å¸³å‹™ / æ”¶è²»</div>
        <div class="inner">
          <div class="kicker">ğŸ’µ å¸³å‹™ / æ”¶è²»</div>
          <div class="title">ç®¡ç†è²»èˆ‡æ”¶æ”¯</div>
          <div class="items">è²»ç”¨æ¸…å–® Â· å‚¬ç¹³ Â· åŒ¯å‡º Â· ç™¼ç¥¨</div>
        </div>
      </div>

      <div class="tile" style="background-image:url('https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?q=80&w=1400&auto=format&fit=crop')" onclick="gotoTab('resident')">
        <div class="badge">ä½æˆ¶ / äººå“¡</div>
        <div class="inner">
          <div class="kicker">ğŸ·ï¸ ä½æˆ¶ / äººå“¡</div>
          <div class="title">ä½æˆ¶èˆ‡ç¤¾å€äººå“¡</div>
          <div class="items">ä½æˆ¶åå†Š Â· ä¸»å§” / ç®¡ç†å“¡</div>
        </div>
      </div>

      <div class="tile" style="background-image:url('https://images.unsplash.com/photo-1529078146-58e3c81d4ebc?q=80&w=1400&auto=format&fit=crop')" onclick="gotoTab('visitor')">
        <div class="badge">è¨ªå®¢ / åŒ…è£¹</div>
        <div class="inner">
          <div class="kicker">ğŸ“¦ è¨ªå®¢ / åŒ…è£¹</div>
          <div class="title">è¨ªå®¢èˆ‡åŒ…è£¹</div>
          <div class="items">é€²å‡ºç´€éŒ„ Â· åŒ…è£¹é ˜å–</div>
        </div>
      </div>

      <div class="tile" style="background-image:url('https://images.unsplash.com/photo-1511578314322-379afb476865?q=80&w=1400&auto=format&fit=crop')" onclick="gotoTab('meeting')">
        <div class="badge">æœƒè­° / æ´»å‹•</div>
        <div class="inner">
          <div class="kicker">ğŸ“ æœƒè­° / æ´»å‹•</div>
          <div class="title">è­°ç¨‹èˆ‡æ´»å‹•</div>
          <div class="items">æœƒè­°ç´€éŒ„ Â· æ´»å‹•æ’ç¨‹</div>
        </div>
      </div>
    </section>

    <!-- å…§é é¢æ¿ -->
    <section class="panel" style="margin-top:18px">
      <div class="panel-body">
        <div class="toolbar" style="margin-bottom:10px">
          <md-filled-button id="btnBack" leading-icon="arrow_back" onclick="backToGrid()" style="display:none">
            <span class="material-symbols-outlined" slot="icon">arrow_back</span>è¿”å›æ¨¡çµ„åˆ—è¡¨
          </md-filled-button>
          <md-filled-tonal-button id="btnAdd" style="display:none">
            <span class="material-symbols-outlined" slot="icon">add</span>æ–°å¢
          </md-filled-tonal-button>
          <md-outlined-button id="btnExport" style="display:none">
            <span class="material-symbols-outlined" slot="icon">ios_share</span>åŒ¯å‡º
          </md-outlined-button>
          <span id="tabHint" class="muted"></span>
        </div>
        <div id="tab-content"></div>
      </div>
    </section>
  </main>

  <!-- å®‰è£ App FABï¼ˆèˆ‡å‰å°ä¸€è‡´ï¼‰ -->
  <md-fab id="installCta" label="å®‰è£ App" variant="secondary">
    <span class="material-symbols-outlined" slot="icon">download</span>
  </md-fab>

  <script>
    /* ========= å‡è³‡æ–™ï¼ˆç°¡åŒ–ç‰ˆï¼‰ ========= */
    const demoAnnouncements=[{id:1,title:"åœæ°´é€šçŸ¥",content:"8/25ä¸Šåˆ9~12é»åœæ°´ã€‚",time:"2025-08-20",author:"æä¸»å§”"}];
    const demoMaintenances=[{id:1,equipment:"é›»æ¢¯",item:"å¹´åº¦ä¿é¤Š",time:"2025-08-10",handler:"ä¿é¤Šå…¬å¸",cost:8000,note:"æ­£å¸¸"}];
    const demoFees=[{id:1,room:"A101",amount:1200,due:"2025-09-10",paid:false,invoice:"INV20250802"}];
    const demoResidents=[{id:1,name:"ç‹å¤§æ˜",room:"A101",phone:"0912-345678"}];
    const demoVisitors=[{id:1,name:"é™³è¨ªå®¢",room:"A101",in:"2025-08-22 10:00",out:"2025-08-22 11:00"}];
    const demoMeetings=[{id:1,topic:"è²¡å‹™å¯©æŸ¥",time:"2025-08-18",location:"æœƒè­°å®¤"}];
    const demoActivities=[{id:1,name:"ä¸­ç§‹çƒ¤è‚‰",time:"2025-09-15 18:00",location:"ä¸­åº­"}];

    /* ========= å„²å­˜å™¨ / ç™»å…¥ç‹€æ…‹ ========= */
    const STORE_KEY = 'kms_user';
    function getUser(){ try{ return JSON.parse(localStorage.getItem(STORE_KEY)||'null'); }catch(e){ return null; } }
    function setUser(u){ localStorage.setItem(STORE_KEY, JSON.stringify(u||{})); }
    function clearUser(){ localStorage.removeItem(STORE_KEY); }
    function isLoggedIn(){ return !!getUser(); }
    function getRole(){ return (getUser()||{}).role || 'user'; }

    function ensureAdmin(){
      const role = getRole();
      if (isLoggedIn() && (role==='admin' || role==='committee')) return true;
      const next = encodeURIComponent('backend.html');
      location.href = `auth.html?next=${next}`;
      return false;
    }

    /* ========= UI ========= */
    function updateAuthUI(){
      const u=getUser()||{};
      document.getElementById('authName').textContent = u.name || u.email || 'ç®¡ç†è€…';
      document.getElementById('authMail').textContent = u.email || 'admin@example.com';
    }

    function logout(){
      clearUser();
      // å°æç¤ºï¼šé€™è£¡å¯æ›æˆ Snackbarï¼›å…ˆç”¨ alert ç°¡åŒ–
      // alert('å·²ç™»å‡º');
      setTimeout(()=>{ location.replace('index.html'); }, 300);
    }

    /* ========= æ¨¡çµ„æ¸²æŸ“ ========= */
    let activeTab = null;

    function backToGrid(){
      activeTab = null;
      document.getElementById('feature-grid').style.display='';
      document.getElementById('btnBack').style.display='none';
      document.getElementById('btnAdd').style.display='none';
      document.getElementById('btnExport').style.display='none';
      document.getElementById('tabHint').textContent='';
      document.getElementById('tab-content').innerHTML='';
      scrollTo({top:0, behavior:'smooth'});
    }

    function gotoTab(key){
      if(!ensureAdmin()) return;
      activeTab = key;
      document.getElementById('feature-grid').style.display='none';
      document.getElementById('btnBack').style.display='';
      document.getElementById('btnAdd').style.display='';
      document.getElementById('btnExport').style.display='';
      document.getElementById('tabHint').textContent = 'ç•¶å‰æ¨¡çµ„ï¼š' + ({
        announcement:'å…¬å‘Š / æŠ•ç¥¨',
        maintenance:'ç¶­ä¿® / å®¢æœ',
        finance:'å¸³å‹™ / æ”¶è²»',
        resident:'ä½æˆ¶ / äººå“¡',
        visitor:'è¨ªå®¢ / åŒ…è£¹',
        meeting:'æœƒè­° / æ´»å‹•'
      }[key] || key);

      renderTabContent();
    }

    function renderTabContent(){
      const el = document.getElementById('tab-content');
      if(!activeTab){ el.innerHTML=''; return; }

      if(activeTab==='announcement'){
        el.innerHTML = `
          <div class="toolbar">
            <md-outlined-text-field id="q1" label="æœå°‹æ¨™é¡Œ" type="search"></md-outlined-text-field>
          </div>
          <div style="overflow:auto">
            <table>
              <thead><tr><th>æ¨™é¡Œ</th><th>æ™‚é–“</th><th>ä½œè€…</th></tr></thead>
              <tbody>${demoAnnouncements.map(x=>`
                <tr><td>${x.title}</td><td>${x.time}</td><td>${x.author}</td></tr>
              `).join('')}</tbody>
            </table>
          </div>`;
      }
      else if(activeTab==='maintenance'){
        el.innerHTML = `
          <div class="toolbar">
            <md-outlined-text-field id="q2" label="è¨­å‚™ / é …ç›®" type="search"></md-outlined-text-field>
          </div>
          <div style="overflow:auto">
            <table>
              <thead><tr><th>è¨­å‚™</th><th>é …ç›®</th><th>æ™‚é–“</th><th>æ‰¿è¾¦</th><th>è²»ç”¨</th><th>å‚™è¨»</th></tr></thead>
              <tbody>${demoMaintenances.map(x=>`
                <tr><td>${x.equipment}</td><td>${x.item}</td><td>${x.time}</td><td>${x.handler}</td><td>$${x.cost}</td><td>${x.note||''}</td></tr>
              `).join('')}</tbody>
            </table>
          </div>`;
      }
      else if(activeTab==='finance'){
        el.innerHTML = `
          <div class="toolbar">
            <md-outlined-text-field id="q3" label="æˆ¿è™Ÿ" type="search"></md-outlined-text-field>
          </div>
          <div style="overflow:auto">
            <table>
              <thead><tr><th>æˆ¿è™Ÿ</th><th>é‡‘é¡</th><th>åˆ°æœŸ</th><th>ç‹€æ…‹</th><th>ç™¼ç¥¨</th></tr></thead>
              <tbody>${demoFees.map(x=>`
                <tr><td>${x.room}</td><td>$${x.amount}</td><td>${x.due}</td><td>${x.paid?'å·²ç¹³':'æœªç¹³'}</td><td>${x.invoice||''}</td></tr>
              `).join('')}</tbody>
            </table>
          </div>`;
      }
      else if(activeTab==='resident'){
        el.innerHTML = `
          <div class="toolbar">
            <md-outlined-text-field id="q4" label="å§“å / æˆ¿è™Ÿ" type="search"></md-outlined-text-field>
          </div>
          <div style="overflow:auto">
            <table>
              <thead><tr><th>å§“å</th><th>æˆ¿è™Ÿ</th><th>é›»è©±</th></tr></thead>
              <tbody>${demoResidents.map(x=>`
                <tr><td>${x.name}</td><td>${x.room}</td><td>${x.phone}</td></tr>
              `).join('')}</tbody>
            </table>
          </div>`;
      }
      else if(activeTab==='visitor'){
        el.innerHTML = `
          <div class="toolbar">
            <md-outlined-text-field id="q5" label="å§“å / æˆ¿è™Ÿ" type="search"></md-outlined-text-field>
          </div>
          <div style="overflow:auto">
            <table>
              <thead><tr><th>å§“å</th><th>æˆ¿è™Ÿ</th><th>é€²å ´</th><th>é›¢å ´</th></tr></thead>
              <tbody>${demoVisitors.map(x=>`
                <tr><td>${x.name}</td><td>${x.room}</td><td>${x.in}</td><td>${x.out||''}</td></tr>
              `).join('')}</tbody>
            </table>
          </div>`;
      }
      else if(activeTab==='meeting'){
        el.innerHTML = `
          <div class="toolbar">
            <md-outlined-text-field id="q6" label="ä¸»é¡Œ / åœ°é»" type="search"></md-outlined-text-field>
          </div>
          <div style="overflow:auto">
            <table>
              <thead><tr><th>ä¸»é¡Œ</th><th>æ™‚é–“</th><th>åœ°é»</th></tr></thead>
              <tbody>${demoMeetings.map(x=>`
                <tr><td>${x.topic||x.name}</td><td>${x.time}</td><td>${x.location}</td></tr>
              `).join('')}</tbody>
            </table>
          </div>
          <div style="margin-top:12px" class="muted">æ´»å‹•ï¼š${demoActivities.map(a=>`${a.name}ï¼ˆ${a.time}@${a.location}ï¼‰`).join('ã€')}</div>`;
      }
      else{
        el.innerHTML = `<div class="muted">æœªæ”¯æ´çš„æ¨¡çµ„ï¼š${activeTab}</div>`;
      }
    }

    /* ========= PWAï¼ˆSW + å®‰è£æŒ‰éˆ•ï¼‰ ========= */
    (function(){
      const fab = document.getElementById('installCta');
      let deferredPrompt = null;

      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js', { scope: './' }).catch(console.warn);
      }

      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        if (fab) fab.style.display = '';
      });

      fab?.addEventListener('click', async () => {
        if (!deferredPrompt) return;
        deferredPrompt.prompt();
        try { await deferredPrompt.userChoice; } catch {}
        deferredPrompt = null;
        fab.style.display = 'none';
      });

      window.addEventListener('appinstalled', () => {
        deferredPrompt = null;
        if (fab) fab.style.display = 'none';
      });
    })();

    /* ========= å•Ÿå‹• ========= */
    window.addEventListener('DOMContentLoaded', () => {
      // æ¬Šé™æª¢æŸ¥ + UI
      if(!ensureAdmin()) return; // æœªé€šéæœƒç›´æ¥å°å‘ auth.html
      updateAuthUI();

      // åˆå§‹ç¶­æŒåœ¨æ¨¡çµ„å¡ç‰‡åˆ—è¡¨
      backToGrid();
    });
  </script>
</body>
</html>
