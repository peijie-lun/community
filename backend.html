<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ç¤¾å€å®¢æœç³»çµ± Â· ç®¡ç†å¾Œå°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0a443f" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="icon-192.png" />
  <link rel="apple-touch-icon" href="icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:FILL@0..1" rel="stylesheet" />
  <script type="module">import 'https://esm.run/@material/web/all.js';</script>
  <style>
    :root{ --container-w: min(1140px, calc(100vw - 24px)); }
    html,body{height:100%}
    body{margin:0;font-family: Roboto, system-ui, -apple-system, "Segoe UI", Arial;}
    md-top-app-bar{ position: sticky; top: 0; z-index: 110; }
    .container{width:var(--container-w);margin-inline:auto}
    .grid{display:grid;gap:18px;grid-template-columns:repeat(auto-fill,minmax(280px,1fr))}
    .tile{position:relative;border-radius:18px;overflow:hidden;min-height:200px;color:#fff;background-size:cover;background-position:center;cursor:pointer;box-shadow:0 8px 24px rgba(0,0,0,.12);transition:transform .15s, box-shadow .15s, filter .15s}
    .tile:hover{ transform:translateY(-2px); box-shadow:0 14px 36px rgba(0,0,0,.18); filter:saturate(1.05); }
    .tile::before{content:"";position:absolute;inset:0;background:linear-gradient(180deg, rgba(0,0,0,.08), rgba(0,0,0,.28))}
    .tile > .inner{position:relative;padding:22px;text-shadow:0 1px 2px rgba(0,0,0,.45)}
    .badge{position:absolute;top:10px;right:10px;background:#FFD54F;color:#2b2b2b;border-radius:999px;padding:6px 10px;font-weight:700;box-shadow:0 8px 24px rgba(0,0,0,.14)}
    .muted{opacity:.66}
    .panel{background:#fff;border-radius:18px;box-shadow:0 8px 28px rgba(0,0,0,.08)}
    .panel-body{padding:18px}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 12px;border-bottom:1px solid #eee;vertical-align:top}
    th{text-align:left;font-weight:800}
    tbody tr:hover{background:#fafafa}

    /* å³ä¸Šè§’ï¼šåªé¡¯ç¤ºç·Šæ€¥å››éµ */
    .emg-wrap{ display:flex; gap:8px; align-items:center; margin-right:6px; }
    .emg-chip{ white-space:nowrap }
  </style>
  <script src="index.js"></script>
  <script> if (!ensureBackend()) { /* å·²è¢«å°å»ç™»å…¥æˆ–é¦–é  */ } </script>
</head>
<body>
  <md-top-app-bar id="topbar">
    <div slot="navigationIcon" style="padding-left:6px"><span class="material-symbols-outlined">apartment</span></div>
    <div slot="headline" style="font-weight:900;letter-spacing:.4px">ç¤¾å€å®¢æœç³»çµ± Â· ç®¡ç†å¾Œå°</div>

    <!-- ğŸ”¥ å³ä¸Šåªæ”¾ç·Šæ€¥å››éµ -->
    <div slot="actionItems" class="emg-wrap">
      <md-assist-chip class="emg-chip" label="æ•‘è­·è»Š(119)" onclick="EmergencyActions.call119()">
        <span class="material-symbols-outlined" slot="icon">ambulance</span>
      </md-assist-chip>
      <md-assist-chip class="emg-chip" label="AED" onclick="EmergencyActions.aed()">
        <span class="material-symbols-outlined" slot="icon">heart_plus</span>
      </md-assist-chip>
      <md-assist-chip class="emg-chip" label="å ±è­¦(110)" onclick="EmergencyActions.call110()">
        <span class="material-symbols-outlined" slot="icon">siren</span>
      </md-assist-chip>
      <md-assist-chip class="emg-chip" label="è·Œå€’(æ¨¡æ“¬)" onclick="EmergencyActions.simFall()">
      </md-assist-chip>

      <!-- å›å‰å° -->
      <md-icon-button id="goFront" aria-label="å›å‰å°" title="å›å‰å°" onclick="location.href='index.html'">
        <span class="material-symbols-outlined">home</span>
      </md-icon-button>

      <!-- å¸³è™Ÿ -->
      <md-menu id="userMenu" anchor="userBtn">
        <md-menu-item disabled>
          <div slot="headline" id="authName">ä½¿ç”¨è€…</div>
          <div slot="supporting-text" id="authMail" class="muted">æœªç™»å…¥</div>
        </md-menu-item>
        <md-divider></md-divider>
        <md-menu-item id="menuLogin" onclick="gotoLogin('backend.html')" style="display:none">
          <span slot="start" class="material-symbols-outlined">login</span>
          <div slot="headline">ç™»å…¥ï¼ˆé¸æ“‡èº«åˆ†ï¼‰</div>
        </md-menu-item>
        <md-menu-item id="menuLogout" onclick="logout()">
          <span slot="start" class="material-symbols-outlined">logout</span>
          <div slot="headline">ç™»å‡º</div>
        </md-menu-item>
      </md-menu>
      <md-icon-button id="userBtn" aria-label="å¸³è™Ÿ" title="å¸³è™Ÿ" onclick="userMenu.show()">
        <span class="material-symbols-outlined">account_circle</span>
      </md-icon-button>
    </div>
  </md-top-app-bar>

  <main class="container" style="padding:22px 0 28px">
    <div style="margin:8px 0 18px">
      <h2 style="font-weight:900;letter-spacing:.3px;margin:0">ç®¡ç†é …ç›®</h2>
      <div class="muted" style="margin-top:6px">ï¼ˆæœ¬å€åƒ…é™ç®¡å§”æœƒä½¿ç”¨ï¼‰</div>
    </div>

    <!-- ç¶­æŒåŸæœ¬çš„æ¨¡çµ„å¡ç‰‡å…¥å£ -->
    <section id="feature-grid" class="grid" aria-live="polite">
      <div class="tile" style="background-image:url('https://images.unsplash.com/photo-1581090463728-28b1b3a4f50b?q=80&w=1400&auto=format&fit=crop')" onclick="gotoTab('announcement')">
        <div class="badge">å…¬å‘Š / æŠ•ç¥¨</div><div class="inner"><div class="title">ç¤¾å€å…¬å‘Šèˆ‡æŠ•ç¥¨</div></div>
      </div>
      <div class="tile" style="background-image:url('https://images.unsplash.com/photo-1581092795360-fd1ca04f0952?q=80&w=1400&auto=format&fit=crop')" onclick="gotoTab('maintenance')">
        <div class="badge">ç¶­ä¿® / å®¢æœ</div><div class="inner"><div class="title">è¨­å‚™ç¶­è­·èˆ‡å®¢æœå–®</div></div>
      </div>
      <div class="tile" style="background-image:url('https://images.unsplash.com/photo-1554224155-8d04cb21cd6c?q=80&w=1400&auto=format&fit=crop')" onclick="gotoTab('finance')">
        <div class="badge">å¸³å‹™ / æ”¶è²»</div><div class="inner"><div class="title">ç®¡ç†è²»èˆ‡æ”¶æ”¯</div></div>
      </div>
      <div class="tile" style="background-image:url('https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?q=80&w=1400&auto=format&fit=crop')" onclick="gotoTab('resident')">
        <div class="badge">ä½æˆ¶ / äººå“¡</div><div class="inner"><div class="title">ä½æˆ¶èˆ‡ç¤¾å€äººå“¡</div></div>
      </div>
      <div class="tile" style="background-image:url('https://images.unsplash.com/photo-1529078146-58e3c81d4ebc?q=80&w=1400&auto=format&fit=crop')" onclick="gotoTab('visitor')">
        <div class="badge">è¨ªå®¢ / åŒ…è£¹</div><div class="inner"><div class="title">è¨ªå®¢èˆ‡åŒ…è£¹</div></div>
      </div>
      <div class="tile" style="background-image:url('https://images.unsplash.com/photo-1511578314322-379afb476865?q=80&w=1400&auto=format&fit=crop')" onclick="gotoTab('meeting')">
        <div class="badge">æœƒè­° / æ´»å‹•</div><div class="inner"><div class="title">è­°ç¨‹èˆ‡æ´»å‹•</div></div>
      </div>
      <!-- ç·Šæ€¥æœå‹™ä¹Ÿä¿ç•™ç‚ºä¸€å€‹æ¨¡çµ„ -->
      <div class="tile" style="background-image:url('https://images.unsplash.com/photo-1516574187841-cb9cc2ca948b?q=80&w=1400&auto=format&fit=crop')" onclick="gotoTab('emergency')">
        <div class="badge">ç·Šæ€¥æœå‹™</div><div class="inner"><div class="title">ç·Šæ€¥äº‹ä»¶ç´€éŒ„ / åŒ¯å‡º</div></div>
      </div>
    </section>

    <section class="panel" style="margin-top:18px">
      <div class="panel-body">
        <div class="toolbar" style="margin-bottom:10px">
          <md-filled-button id="btnBack" leading-icon="arrow_back" onclick="backToGrid()" style="display:none">
            <span class="material-symbols-outlined" slot="icon">arrow_back</span>è¿”å›æ¨¡çµ„åˆ—è¡¨
          </md-filled-button>

          <md-filled-tonal-button id="btnAdd" style="display:none">
            <span class="material-symbols-outlined" slot="icon">add</span>æ–°å¢
          </md-filled-tonal-button>

          <!-- åªæœ‰ç·Šæ€¥æœå‹™æœƒé¡¯ç¤º -->
          <md-outlined-button id="btnExport" style="display:none">
            <span class="material-symbols-outlined" slot="icon">download</span>åŒ¯å‡º CSV
          </md-outlined-button>

          <span id="tabHint" class="muted"></span>
        </div>
        <div id="tab-content"></div>
      </div>
    </section>
  </main>

  <script>
    initPage('backend');

    function backToGrid(){
      document.getElementById('feature-grid').style.display='';
      document.getElementById('btnBack').style.display='none';
      document.getElementById('btnAdd').style.display='none';
      document.getElementById('btnExport').style.display='none';
      document.getElementById('tabHint').textContent='';
      document.getElementById('tab-content').innerHTML='';
      scrollTo({top:0, behavior:'smooth'});
    }
    backToGrid();

    let currentTab = '';
    function gotoTab(key){
      currentTab = key;
      document.getElementById('feature-grid').style.display='none';
      document.getElementById('btnBack').style.display='';
      document.getElementById('btnAdd').style.display='';
      document.getElementById('btnExport').style.display = (key==='emergency') ? '' : 'none';
      document.getElementById('tabHint').textContent = 'ç•¶å‰æ¨¡çµ„ï¼š' + ({
        announcement:'å…¬å‘Š / æŠ•ç¥¨', maintenance:'ç¶­ä¿® / å®¢æœ', finance:'å¸³å‹™ / æ”¶è²»',
        resident:'ä½æˆ¶ / äººå“¡', visitor:'è¨ªå®¢ / åŒ…è£¹', meeting:'æœƒè­° / æ´»å‹•',
        emergency:'ç·Šæ€¥æœå‹™'
      }[key] || key);

      document.getElementById('btnAdd').onclick = () => {
        if (key==='announcement') {
          const title = prompt('å…¬å‘Šæ¨™é¡Œï¼š'); if (!title) return;
          Ann.create({ title, content:'' });
        } else if (key==='maintenance') {
          const item = prompt('ç¶­ä¿®é …ç›®ï¼š'); if (!item) return;
          Maint.create({ equipment:'è¨­å‚™', item, handler:'', cost:0 });
        } else if (key==='finance') {
          const room = prompt('æˆ¿è™Ÿï¼š'); if (!room) return;
          const amount = Number(prompt('é‡‘é¡ï¼š')||0);
          Fee.create({ room, amount, due:'' });
        } else if (key==='resident') {
          const name = prompt('å§“åï¼š'); if (!name) return;
          const room = prompt('æˆ¿è™Ÿï¼š')||'';
          Resi.create({ name, room });
        } else if (key==='visitor') {
          const name = prompt('è¨ªå®¢å§“åï¼š'); if (!name) return;
          const room = prompt('æˆ¿è™Ÿï¼š')||'';
          Visit.checkin({ name, room });
        } else if (key==='meeting') {
          const topic = prompt('æœƒè­°ä¸»é¡Œï¼š'); if (!topic) return;
          Meet.create({ topic, time:'', location:'' });
        } else if (key==='emergency') {
          const type = prompt('äº‹ä»¶é¡å‹ï¼ˆä¾‹å¦‚ï¼šæ•‘è­·è»Š 119 / å ±è­¦ 110 / AED / å…¶ä»–ï¼‰ï¼š'); if (!type) return;
          const note = prompt('å‚™è¨»ï¼ˆé¸å¡«ï¼‰ï¼š') || '';
          Emergency.create({ type, note });
        }
      };

      document.getElementById('btnExport').onclick = () => {
        if (key!=='emergency') return;
        const rows = Emergency.list();
        exportCSV(rows, `emergencies_${new Date().toISOString().slice(0,10)}.csv`);
      };

      renderTabContent(key);
    }

    function renderTabContent(tab){
      const el = document.getElementById('tab-content');
      if(tab==='announcement'){
        const rows = Ann.list();
        el.innerHTML = `
          <div style="overflow:auto">
            <table>
              <thead><tr><th>æ¨™é¡Œ</th><th>æ™‚é–“</th><th>ä½œè€…</th><th>æŠ•ç¥¨</th><th>å‹•ä½œ</th></tr></thead>
              <tbody>${rows.map(x=>`
                <tr>
                  <td>${x.title}</td>
                  <td>${(x.time||'').toString().slice(0,16).replace('T',' ')}</td>
                  <td>${x.author||''}</td>
                  <td>${(x.options||[]).map(o=>`${o}:${x.votes?.[o]||0}`).join(' / ')}</td>
                  <td><md-text-button style="color:#b00020" onclick="(function(){ if(confirm('åˆªé™¤æ­¤å…¬å‘Šï¼Ÿ')) Ann.remove('${x.id}'); })()">åˆªé™¤</md-text-button></td>
                </tr>
              `).join('')}</tbody>
            </table>
          </div>`;
      } else if(tab==='maintenance'){
        const rows = Maint.list();
        el.innerHTML = `
          <div style="overflow:auto">
            <table>
              <thead><tr><th>è¨­å‚™</th><th>é …ç›®</th><th>æ™‚é–“</th><th>æ‰¿è¾¦</th><th>è²»ç”¨</th><th>ç‹€æ…‹</th><th>æŒ‡æ´¾</th><th>å‹•ä½œ</th></tr></thead>
              <tbody>${rows.map(x=>`
                <tr>
                  <td>${x.equipment}</td><td>${x.item}</td><td>${x.time}</td>
                  <td>${x.handler||''}</td><td>$${x.cost||0}</td><td>${x.status}</td><td>${x.assignee||''}</td>
                  <td>
                    <md-text-button onclick="Maint.setStatus('${x.id}','open')">é–‹å–®</md-text-button>
                    <md-text-button onclick="Maint.setStatus('${x.id}','progress')">è™•ç†ä¸­</md-text-button>
                    <md-text-button onclick="Maint.setStatus('${x.id}','closed')">çµæ¡ˆ</md-text-button>
                    <md-text-button onclick="(function(){ const p=prompt('æŒ‡æ´¾å°è±¡ï¼š', '${x.assignee||''}'); if(p!=null) Maint.assign('${x.id}', p); })()">æŒ‡æ´¾</md-text-button>
                    <md-text-button style="color:#b00020" onclick="(function(){ if(confirm('åˆªé™¤æ­¤å·¥å–®ï¼Ÿ')) Maint.remove('${x.id}'); })()">åˆªé™¤</md-text-button>
                  </td>
                </tr>
              `).join('')}</tbody>
            </table>
          </div>`;
      } else if(tab==='finance'){
        const rows = Fee.list();
        el.innerHTML = `
          <div style="overflow:auto">
            <table>
              <thead><tr><th>æˆ¿è™Ÿ</th><th>é‡‘é¡</th><th>åˆ°æœŸ</th><th>ç‹€æ…‹</th><th>ç™¼ç¥¨</th><th>å‹•ä½œ</th></tr></thead>
              <tbody>${rows.map(x=>`
                <tr>
                  <td>${x.room}</td><td>$${x.amount}</td><td>${x.due||''}</td><td>${x.paid?'å·²ç¹³':'æœªç¹³'}</td><td>${x.invoice||''}</td>
                  <td>
                    <md-text-button onclick="(function(){ Fee.setPaid('${x.id}', ${!x.paid}); })()">${x.paid?'è¨­ç‚ºæœªç¹³':'è¨­ç‚ºå·²ç¹³'}</md-text-button>
                    <md-text-button style="color:#b00020" onclick="(function(){ if(confirm('åˆªé™¤æ­¤è²»ç”¨ï¼Ÿ')) Fee.remove('${x.id}'); })()">åˆªé™¤</md-text-button>
                  </td>
                </tr>
              `).join('')}</tbody>
            </table>
          </div>`;
      } else if(tab==='resident'){
        const rows = Resi.list();
        el.innerHTML = `
          <div style="overflow:auto">
            <table>
              <thead><tr><th>å§“å</th><th>æˆ¿è™Ÿ</th><th>é›»è©±</th><th>Email</th><th>èº«åˆ†</th><th>å‹•ä½œ</th></tr></thead>
              <tbody>${rows.map(x=>`
                <tr>
                  <td>${x.name}</td><td>${x.room}</td><td>${x.phone||''}</td><td>${x.email||''}</td><td>${x.role||''}</td>
                  <td><md-text-button style="color:#b00020" onclick="(function(){ if(confirm('åˆªé™¤æ­¤ä½æˆ¶ï¼Ÿ')) Resi.remove('${x.id}'); })()">åˆªé™¤</md-text-button></td>
                </tr>
              `).join('')}</tbody>
            </table>
          </div>`;
      } else if(tab==='visitor'){
        const rows = Visit.list();
        el.innerHTML = `
          <div style="overflow:auto">
            <table>
              <thead><tr><th>å§“å</th><th>æˆ¿è™Ÿ</th><th>é€²å ´</th><th>é›¢å ´</th><th>å‹•ä½œ</th></tr></thead>
              <tbody>${rows.map(x=>`
                <tr>
                  <td>${x.name}</td><td>${x.room}</td><td>${x.in||''}</td><td>${x.out||''}</td>
                  <td>
                    ${x.out ? '' : `<md-text-button onclick="Visit.checkout('${x.id}')">ç°½å‡º</md-text-button>`}
                    <md-text-button style="color:#b00020" onclick="(function(){ if(confirm('åˆªé™¤æ­¤ç´€éŒ„ï¼Ÿ')) Visit.remove('${x.id}'); })()">åˆªé™¤</md-text-button>
                  </td>
                </tr>
              `).join('')}</tbody>
            </table>
          </div>`;
      } else if(tab==='meeting'){
        const rows = Meet.list();
        el.innerHTML = `
          <div style="overflow:auto">
            <table>
              <thead><tr><th>ä¸»é¡Œ</th><th>æ™‚é–“</th><th>åœ°é»</th><th>å‚™è¨»</th><th>å‹•ä½œ</th></tr></thead>
              <tbody>${rows.map(x=>`
                <tr>
                  <td>${x.topic||x.name}</td><td>${x.time||''}</td><td>${x.location||''}</td><td>${x.notes||''}</td>
                  <td><md-text-button style="color:#b00020" onclick="(function(){ if(confirm('åˆªé™¤æ­¤æœƒè­°ï¼Ÿ')) Meet.remove('${x.id}'); })()">åˆªé™¤</md-text-button></td>
                </tr>
              `).join('')}</tbody>
            </table>
          </div>`;
      } else if(tab==='emergency'){
        const rows = Emergency.list();
        el.innerHTML = `
          <div style="overflow:auto">
            <table>
              <thead>
                <tr><th>é¡å‹</th><th>æ™‚é–“</th><th>ä½¿ç”¨è€…</th><th>ç´€éŒ„</th><th>å‹•ä½œ</th></tr>
              </thead>
              <tbody>${rows.map(x=>`
                <tr>
                  <td>${x.type||''}</td>
                  <td>${(x.time||'').toString().slice(0,16).replace('T',' ')}</td>
                  <td>${x.by||''}</td>
                  <td>${x.note||''}</td>
                  <td>
                    <md-text-button style="color:#b00020" onclick="(function(){ if(confirm('åˆªé™¤æ­¤ç·Šæ€¥ç´€éŒ„ï¼Ÿ')) Emergency.remove('${x.id}'); })()">åˆªé™¤</md-text-button>
                  </td>
                </tr>
              `).join('')}</tbody>
            </table>
          </div>
          <div class="muted" style="margin-top:8px">ï¼Šè³‡æ–™ç›®å‰å„²å­˜åœ¨æœ¬æ©Ÿ LocalStorageï¼›è‹¥è¦æ¨æ’­ã€ç°¡è¨Šã€å¤–å‘¼ï¼Œè«‹ä¸²æ¥å¾Œç«¯æœå‹™ã€‚</div>
        `;
      } else {
        el.innerHTML = `<div class="muted">æœªæ”¯æ´çš„æ¨¡çµ„ï¼š${tab}</div>`;
      }
    }

    // åŒ¯å‡ºå·¥å…·ï¼ˆCSVï¼‰
    function exportCSV(rows, filename='export.csv'){
      const header = ['type','time','by','note'];
      const esc = (s)=>('"'+String(s??'').replace(/"/g,'""')+'"');
      const body = rows.map(r=>[r.type, r.time, r.by, r.note].map(esc).join(',')).join('\n');
      const csv = header.join(',') + '\n' + body;
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; a.click();
      setTimeout(()=>URL.revokeObjectURL(url), 500);
    }
  </script>
</body>
</html>
